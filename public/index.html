<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdaptLearn Adventure - The Knowledge Quest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #1a1a2e; color: #e2e8f0; overflow-x: hidden; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .glass-strong { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(16px); border-right: 1px solid rgba(255,255,255,0.05); }
        .hover-bounce:hover { transform: translateY(-3px); }
        .btn-game { background: linear-gradient(to bottom, #f59e0b, #d97706); border: 2px solid #78350f; box-shadow: 0 4px 0 #78350f; color: white; text-shadow: 1px 1px 0 #78350f; transition: all 0.1s; }
        .btn-game:active { transform: translateY(4px); box-shadow: 0 0 0 #78350f; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>

<body class="bg-slate-900 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">

    <!-- LOGIN SCREEN (If not logged in) -->
    <div id="guest-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] hidden">
        <div class="text-center p-8 max-w-md w-full glass rounded-3xl shadow-2xl border border-slate-700 fade-in">
            <div class="text-6xl mb-6">üõ°Ô∏è</div>
            <h1 class="text-3xl font-bold text-white mb-2">AdaptLearn Adventure</h1>
            <p class="text-slate-400 mb-8">Embark on your knowledge quest!</p>
            <a href="/login.html" class="block w-full py-3.5 bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 text-white font-bold rounded-xl shadow-lg transition transform hover:scale-105 active:scale-95 mb-4">
                Login / Register
            </a>
            <div class="text-xs text-slate-500">v2.1.0 ‚Ä¢ Ready</div>
        </div>
    </div>

    <!-- MAIN APP LAYOUT -->
    <div id="app-layout" class="flex h-screen hidden">
        
        <!-- SIDEBAR (Desktop) -->
        <aside class="w-20 lg:w-64 glass-strong hidden md:flex flex-col z-40 transition-all duration-300">
            <!-- Logo -->
            <div class="h-20 flex items-center justify-center lg:justify-start lg:px-6 border-b border-slate-800">
                <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center text-white text-xl shadow-lg">üß†</div>
                <span class="ml-3 font-bold text-lg text-white hidden lg:block tracking-wide">AdaptLearn</span>
            </div>

            <!-- Nav Menu -->
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <div onclick="Game.ui.tab('dashboard')" class="flex items-center gap-4 p-3 rounded-xl transition-all duration-200 text-slate-400 hover:bg-slate-800 hover:text-white cursor-pointer active nav-item" id="nav-dashboard">
                    <div class="w-10 h-10 flex items-center justify-center rounded-lg bg-slate-800 text-xl"><i class="fa-solid fa-map"></i></div>
                    <span class="hidden lg:block font-medium">Adventure</span>
                </div>
                <div onclick="Game.ui.tab('leaderboard')" class="flex items-center gap-4 p-3 rounded-xl transition-all duration-200 text-slate-400 hover:bg-slate-800 hover:text-white cursor-pointer nav-item" id="nav-leaderboard">
                    <div class="w-10 h-10 flex items-center justify-center rounded-lg bg-slate-800 text-xl"><i class="fa-solid fa-trophy"></i></div>
                    <span class="hidden lg:block font-medium">Leaderboard</span>
                </div>
                <div onclick="Game.ui.tab('shop')" class="flex items-center gap-4 p-3 rounded-xl transition-all duration-200 text-slate-400 hover:bg-slate-800 hover:text-white cursor-pointer nav-item" id="nav-shop">
                    <div class="w-10 h-10 flex items-center justify-center rounded-lg bg-slate-800 text-xl"><i class="fa-solid fa-store"></i></div>
                    <span class="hidden lg:block font-medium">Item Shop</span>
                </div>
                <div onclick="window.location.href='/profile.html'" class="flex items-center gap-4 p-3 rounded-xl transition-all duration-200 text-slate-400 hover:bg-slate-800 hover:text-white cursor-pointer nav-item">
                    <div class="w-10 h-10 flex items-center justify-center rounded-lg bg-slate-800 text-xl"><i class="fa-solid fa-user-astronaut"></i></div>
                    <span class="hidden lg:block font-medium">My Profile</span>
                </div>
                
                <!-- Admin Only -->
                <a href="/admin.html" id="menu-admin" class="flex items-center gap-4 p-3 rounded-xl transition-all duration-200 text-yellow-500 hover:bg-slate-800 cursor-pointer hidden">
                    <div class="w-10 h-10 flex items-center justify-center rounded-lg bg-slate-800 text-xl"><i class="fa-solid fa-wand-magic-sparkles"></i></div>
                    <span class="hidden lg:block font-medium">Instructor</span>
                </a>
            </nav>

            <!-- Bottom Action (Logout) -->
            <div class="p-4 border-t border-slate-800">
                <button onclick="Game.auth.logout()" class="w-full flex items-center gap-4 p-3 rounded-xl transition-all duration-200 text-red-400 hover:bg-red-500/10 group">
                    <div class="w-10 h-10 flex items-center justify-center rounded-lg bg-slate-800 text-xl group-hover:bg-red-500 group-hover:text-white"><i class="fa-solid fa-right-from-bracket"></i></div>
                    <span class="hidden lg:block font-medium">Logout</span>
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-1 flex flex-col relative overflow-hidden">
            
            <!-- Mobile Header -->
            <header class="md:hidden h-16 glass flex items-center justify-between px-4 z-40">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white">üß†</div>
                    <span class="font-bold text-white">AdaptLearn</span>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-1 bg-slate-800 px-2 py-1 rounded-full border border-slate-700">
                        <span>ü™ô</span><span class="text-xs font-bold text-yellow-400" id="mob-coins">0</span>
                    </div>
                    <img src="" id="mob-avatar" class="w-8 h-8 rounded-full bg-slate-700 border border-slate-500 object-cover" onclick="window.location.href='/profile.html'" style="display:none">
                    <div id="mob-avatar-txt" class="w-8 h-8 rounded-full bg-slate-700 border border-slate-500 flex items-center justify-center" onclick="window.location.href='/profile.html'">üôÇ</div>
                </div>
            </header>

            <!-- Top HUD (Desktop) -->
            <div class="hidden md:flex justify-between items-center px-8 py-4 z-30">
                <div class="flex items-center gap-4">
                    <h2 class="text-2xl font-bold text-white" id="page-title">World Map</h2>
                </div>
                <div class="flex items-center gap-6 glass px-6 py-2 rounded-2xl">
                    <div class="flex items-center gap-3" title="Your Wealth">
                        <div class="w-10 h-10 rounded-full bg-yellow-500/20 text-yellow-400 flex items-center justify-center text-xl border border-yellow-500/50">ü™ô</div>
                        <div>
                            <div class="text-[10px] text-slate-400 uppercase font-bold">Coins</div>
                            <div class="text-lg font-bold text-white leading-none" id="hud-coins">0</div>
                        </div>
                    </div>
                    <div class="w-[1px] h-8 bg-slate-700"></div>
                    <div class="flex items-center gap-3" title="Login Streak">
                        <div class="w-10 h-10 rounded-full bg-orange-500/20 text-orange-400 flex items-center justify-center text-xl border border-orange-500/50">üî•</div>
                        <div>
                            <div class="text-[10px] text-slate-400 uppercase font-bold">Streak</div>
                            <div class="text-lg font-bold text-white leading-none" id="hud-streak">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Scroll Area -->
            <div class="flex-1 overflow-y-auto overflow-x-hidden relative custom-scrollbar p-4 md:p-8" id="content-area">
                
                <!-- 1. DASHBOARD VIEW -->
                <div id="view-dashboard" class="view-section fade-in space-y-8">
                    <!-- Hero Section -->
                    <div class="flex flex-col md:flex-row items-center gap-8 bg-gradient-to-r from-indigo-900/50 to-slate-900/50 p-8 rounded-3xl border border-indigo-500/30 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-indigo-500/20 blur-[80px] rounded-full"></div>
                        
                        <div class="relative z-10">
                            <div class="w-32 h-32 md:w-40 md:h-40 bg-slate-800 rounded-full border-4 border-indigo-500 flex items-center justify-center text-6xl shadow-2xl avatar-bob overflow-hidden">
                                <span id="dash-avatar-txt">üôÇ</span>
                                <img id="dash-avatar-img" class="w-full h-full object-cover hidden">
                            </div>
                            <div class="absolute -bottom-3 left-1/2 -translate-x-1/2 bg-indigo-600 text-white text-xs font-bold px-3 py-1 rounded-full whitespace-nowrap shadow-lg" id="dash-role">Student</div>
                        </div>
                        
                        <div class="flex-1 text-center md:text-left z-10">
                            <h2 class="text-3xl font-bold text-white mb-2">Welcome back, <span id="dash-name" class="text-indigo-400">Hero</span>!</h2>
                            <p class="text-slate-400 mb-6 max-w-lg">Your journey continues. Check your daily quests or dive into the adventure map below.</p>
                            
                            <!-- Level Progress -->
                            <div class="bg-slate-800/80 p-4 rounded-xl border border-slate-700 max-w-md">
                                <div class="flex justify-between text-xs font-bold text-slate-400 mb-2">
                                    <span>Level <span id="dash-lvl" class="text-white">1</span></span>
                                    <span id="dash-xp-text">0 / 100 XP</span>
                                </div>
                                <div class="w-full h-3 bg-slate-700 rounded-full overflow-hidden">
                                    <div id="dash-xp-bar" class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 w-0 transition-all duration-1000"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Adventure Map Container -->
                    <div class="relative min-h-[600px] bg-slate-900 rounded-3xl border border-slate-700 shadow-inner overflow-hidden" id="map-wrapper">
                        <div class="absolute top-4 left-4 z-20 flex gap-2">
                            <span class="bg-slate-800/80 backdrop-blur text-white px-4 py-2 rounded-lg text-sm font-bold border border-slate-600" id="map-title-badge">üó∫Ô∏è All Worlds</span>
                            <button onclick="Game.render.map(null)" class="bg-slate-700 text-white px-3 py-2 rounded-lg text-xs hover:bg-slate-600 hidden" id="map-back-btn">‚¨ÖÔ∏è Back</button>
                        </div>
                        <svg class="absolute inset-0 w-full h-full z-0" id="map-svg"></svg>
                        <div id="map-nodes" class="relative z-10 w-full h-full"></div>
                    </div>
                </div>

                <!-- 2. LEADERBOARD VIEW -->
                <div id="view-leaderboard" class="view-section hidden fade-in max-w-3xl mx-auto">
                    <div class="text-center mb-8">
                        <div class="text-6xl mb-4">üèÜ</div>
                        <h2 class="text-3xl font-bold text-white">Hall of Fame</h2>
                        <p class="text-slate-400">Top heroes of the realm</p>
                    </div>
                    <div class="bg-slate-800 rounded-2xl border border-slate-700 overflow-hidden" id="lb-container">
                        <!-- List injected here -->
                    </div>
                </div>

                <!-- 3. SHOP VIEW -->
                <div id="view-shop" class="view-section hidden fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 space-y-6">
                            <h2 class="text-2xl font-bold text-white flex items-center gap-3"><span class="text-3xl">üè™</span> Marketplace</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" id="shop-items"></div>
                        </div>
                        <div class="bg-slate-800 rounded-2xl p-6 border border-slate-700 h-fit">
                            <h3 class="font-bold text-white mb-4 border-b border-slate-700 pb-2">üéí Inventory</h3>
                            <div id="user-inventory" class="space-y-2 text-sm text-slate-400">Empty...</div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Mobile Bottom Nav -->
            <nav class="md:hidden h-16 glass-strong flex justify-around items-center px-2 z-50 fixed bottom-0 w-full border-t border-slate-800">
                <button onclick="Game.ui.tab('dashboard')" class="p-2 text-slate-400 hover:text-indigo-400 active:text-indigo-500 flex flex-col items-center">
                    <i class="fa-solid fa-map text-lg"></i><span class="text-[10px]">Map</span>
                </button>
                <button onclick="Game.ui.tab('leaderboard')" class="p-2 text-slate-400 hover:text-yellow-400 flex flex-col items-center">
                    <i class="fa-solid fa-trophy text-lg"></i><span class="text-[10px]">Rank</span>
                </button>
                <div class="relative -top-5">
                    <button onclick="Game.ai.toggle()" class="w-14 h-14 bg-indigo-600 rounded-full flex items-center justify-center text-white shadow-lg border-4 border-slate-900 hover:scale-110 transition">
                        <i class="fa-solid fa-robot text-xl"></i>
                    </button>
                </div>
                <button onclick="Game.ui.tab('shop')" class="p-2 text-slate-400 hover:text-blue-400 flex flex-col items-center">
                    <i class="fa-solid fa-store text-lg"></i><span class="text-[10px]">Shop</span>
                </button>
                <button onclick="Game.auth.logout()" class="p-2 text-slate-400 hover:text-red-400 flex flex-col items-center">
                    <i class="fa-solid fa-door-open text-lg"></i><span class="text-[10px]">Exit</span>
                </button>
            </nav>

            <!-- AI Chat Floating (Desktop) -->
            <div id="ai-widget" class="hidden md:flex fixed bottom-8 right-8 z-50 flex-col items-end gap-4">
                <div id="ai-window" class="w-80 h-96 bg-slate-800 rounded-2xl shadow-2xl border border-slate-600 flex flex-col hidden overflow-hidden animate-zoom-in">
                    <div class="bg-slate-900 p-3 flex justify-between items-center border-b border-slate-700">
                        <span class="font-bold text-indigo-400 text-sm">ü§ñ AI Game Master</span>
                        <button onclick="Game.ai.toggle()" class="text-slate-500 hover:text-white">‚úï</button>
                    </div>
                    <div id="ai-chat-box" class="flex-1 p-3 overflow-y-auto space-y-3 bg-slate-800/50 text-sm">
                        <div class="text-slate-400 text-center text-xs mt-4">Ask me anything about your quest!</div>
                    </div>
                    <div class="p-2 bg-slate-900 border-t border-slate-700 flex gap-2">
                        <input id="ai-input" class="flex-1 bg-slate-800 border border-slate-600 rounded-lg px-3 py-1 text-sm text-white outline-none focus:border-indigo-500" placeholder="Type...">
                        <button onclick="Game.ai.send()" class="bg-indigo-600 text-white px-3 py-1 rounded-lg text-xs font-bold">Send</button>
                    </div>
                </div>
                <button onclick="Game.ai.toggle()" class="w-14 h-14 bg-indigo-600 hover:bg-indigo-500 text-white rounded-full shadow-xl flex items-center justify-center text-2xl transition hover:scale-110 active:scale-95">
                    <i class="fa-solid fa-robot"></i>
                </button>
            </div>

        </main>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        const Game = {
            data: { user: null, activities: [], items: [], inventory: [], currentWorld: null },
            
            init: async () => {
                const uid = sessionStorage.getItem('user_id');
                console.log("Checking Auth for ID:", uid);

                if (!uid) {
                    document.getElementById('guest-screen').classList.remove('hidden');
                    return;
                }

                // Show Layout
                document.getElementById('app-layout').classList.remove('hidden');
                
                // Fetch Data
                await Game.api.loadAll(uid);
                
                // Render
                Game.render.hud();
                Game.render.dashboard();
                
                // Listeners
                const aiInput = document.getElementById('ai-input');
                if(aiInput) aiInput.addEventListener('keypress', (e) => e.key === 'Enter' && Game.ai.send());
            },

            ui: {
                tab: (name) => {
                    document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                    const target = document.getElementById(`view-${name}`);
                    if(target) target.classList.remove('hidden');
                    
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                    const navBtn = document.getElementById(`nav-${name}`);
                    if(navBtn) navBtn.classList.add('active');

                    if (name === 'leaderboard') Game.render.leaderboard();
                    if (name === 'shop') Game.render.shop();
                    if (name === 'dashboard') Game.render.map(Game.data.currentWorld);
                }
            },

            auth: {
                logout: () => { sessionStorage.clear(); window.location.href = '/login.html'; }
            },

            api: {
                fetchAll: async () => {
                    const uid = sessionStorage.getItem('user_id');
                    if(!uid) return;

                    try {
                        const [uRes, aRes] = await Promise.all([
                            fetch(`/api/analytics?userId=${uid}`), 
                            fetch('/api/activities')
                        ]);
                        
                        const userData = await uRes.json();
                        const actData = await aRes.json();

                        // --- PERSISTENCE LOGIC (LOCAL SAVE) ---
                        // If we get mock data or DB is down, try loading from LocalStorage
                        const localSave = localStorage.getItem(`save_user_${uid}`);
                        let finalUser = userData.user;

                        if (localSave && (!finalUser || finalUser.id === 99)) {
                            finalUser = JSON.parse(localSave);
                            console.log("üéÆ Loaded from Local Save");
                        }

                        Game.data.user = finalUser || { id: uid, name: 'Guest Hero', level: 1, xp: 0, coins: 0 };
                        Game.data.activities = actData || [];
                        
                        Game.render.hud();
                        Game.render.dashboard();
                    } catch (e) { console.error("API Error", e); }
                },
                saveProgress: async (actId, score, status) => {
                    const u = Game.data.user;
                    if(!u) return;

                    // 1. Update UI / Local State immediately
                    if(status === 'completed') {
                        u.xp += 100;
                        u.coins += 50;
                        u.level = Math.floor(u.xp / 1000) + 1;
                        // Save to Browser
                        localStorage.setItem(`save_user_${u.id}`, JSON.stringify(u));
                    }

                    // 2. Try to sync with Server
                    try {
                        await fetch('/api/progress', {
                            method: 'POST',
                            headers: {'Content-Type':'application/json'},
                            body: JSON.stringify({ userId: u.id, activityId: actId, score, status })
                        });
                    } catch(e) { console.warn("Server sync failed, saved locally."); }
                    
                    Game.render.hud();
                    Game.render.dashboard();
                }
            },

            render: {
                hud: () => {
                    const u = Game.data.user;
                    if(!u) return;
                    document.getElementById('hud-coins').innerText = (u.coins || 0).toLocaleString();
                    document.getElementById('hud-streak').innerText = u.streak || 0;
                    document.getElementById('mob-coins').innerText = (u.coins || 0);
                    
                    const avatarImg = document.getElementById('mob-avatar');
                    const avatarTxt = document.getElementById('mob-avatar-txt');
                    if(u.avatar && u.avatar.includes('/')) {
                        avatarImg.src = u.avatar; avatarImg.style.display = 'block'; avatarTxt.style.display = 'none';
                    } else {
                        avatarTxt.innerText = u.avatar || 'üôÇ'; avatarTxt.style.display = 'flex'; avatarImg.style.display = 'none';
                    }

                    if (u.role === 'admin' || u.role === 'teacher') document.getElementById('menu-admin').classList.remove('hidden');
                },
                dashboard: () => {
                    const u = Game.data.user;
                    document.getElementById('dash-name').innerText = u.name;
                    document.getElementById('dash-role').innerText = (u.role || 'Student').toUpperCase();
                    document.getElementById('dash-lvl').innerText = u.level;
                    
                    const nextXP = u.level * 100;
                    const pct = Math.min(((u.xp || 0) / nextXP) * 100, 100);
                    document.getElementById('dash-xp-bar').style.width = `${pct}%`;
                    document.getElementById('dash-xp-text').innerText = `${u.xp || 0} / ${nextXP} XP`;

                    const avImg = document.getElementById('dash-avatar-img');
                    const avTxt = document.getElementById('dash-avatar-txt');
                    if(u.avatar && u.avatar.includes('/')) {
                        avImg.src = u.avatar; avImg.classList.remove('hidden'); avTxt.classList.add('hidden');
                    } else {
                        avTxt.innerText = u.avatar || 'üôÇ'; avTxt.classList.remove('hidden'); avImg.classList.add('hidden');
                    }
                    
                    Game.render.map(null);
                },
                map: (category) => {
                    const container = document.getElementById('map-nodes');
                    const svg = document.getElementById('map-svg');
                    container.innerHTML = ''; svg.innerHTML = '';
                    
                    let acts = Game.data.activities;
                    
                    // Filter Mode
                    if(category) {
                        acts = acts.filter(a => (a.category || 'General') === category);
                        document.getElementById('map-title-badge').innerText = `üó∫Ô∏è ${category}`;
                        document.getElementById('map-back-btn').classList.remove('hidden');
                    } else {
                        // World Mode
                        document.getElementById('map-title-badge').innerText = `üåå Galactic Map`;
                        document.getElementById('map-back-btn').classList.add('hidden');
                        
                        // Show Categories as Planets
                        const categories = [...new Set(acts.map(a => a.category || 'General'))];
                        const icons = { 'Mathematics': 'üìê', 'Science': 'üß™', 'English': 'üìö', 'Technology': 'üíª', 'General': 'üåç', 'Social Studies': 'üèõÔ∏è', 'Arts': 'üé®', 'Health': '‚ù§Ô∏è', 'Business': 'üíº' };
                        
                        categories.forEach((cat, i) => {
                            const top = 50 + (Math.floor(i/2) * 200);
                            const left = i%2===0 ? '25%' : '65%';
                            
                            const planet = document.createElement('div');
                            planet.className = "absolute w-40 h-40 bg-slate-800 border-4 border-slate-600 rounded-full flex flex-col items-center justify-center cursor-pointer hover:scale-110 hover:border-indigo-500 transition shadow-2xl z-20";
                            planet.style.top = `${top}px`;
                            planet.style.left = left;
                            planet.innerHTML = `<div class="text-5xl mb-2">${icons[cat]||'ü™ê'}</div><div class="font-bold text-white">${cat}</div>`;
                            planet.onclick = () => { Game.data.currentWorld = cat; Game.render.map(cat); };
                            container.appendChild(planet);
                        });
                        return; // Done rendering worlds
                    }

                    // Render Activities Nodes (Inside Category)
                    acts.forEach((act, i) => {
                        const top = 50 + (i * 150);
                        const left = (i % 2 === 0) ? '20%' : '60%';
                        
                        const node = document.createElement('div');
                        node.className = `absolute w-20 h-20 bg-slate-800 border-4 border-indigo-500 rounded-2xl flex flex-col items-center justify-center text-2xl shadow-lg hover:scale-110 transition cursor-pointer z-10`;
                        node.style.top = `${top}px`;
                        node.style.left = left;
                        node.innerHTML = `<span class="filter drop-shadow-md">${act.type==='video'?'üìú':'üéÆ'}</span>`;
                        node.onclick = () => alert(`Starting Mission: ${act.title}`); // Placeholder player launch
                        
                        const label = document.createElement('div');
                        label.className = "absolute -bottom-8 left-1/2 -translate-x-1/2 text-[10px] font-bold text-white bg-slate-900 px-2 py-1 rounded whitespace-nowrap border border-slate-700";
                        label.innerText = act.title;
                        node.appendChild(label);

                        container.appendChild(node);
                    });
                    
                    // Background
                    document.getElementById('map-wrapper').style.background = `radial-gradient(circle at center, #0f172a 0%, #020617 100%), url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4wNSkiLz48L3N2Zz4=')`;
                },
                leaderboard: async () => {
                    const box = document.getElementById('lb-container');
                    box.innerHTML = '<div class="p-8 text-center text-slate-500">Loading...</div>';
                    try {
                        const res = await fetch('/api/leaderboard');
                        const data = await res.json();
                        box.innerHTML = data.map((u, i) => `
                            <div class="flex items-center gap-4 p-4 border-b border-slate-700 bg-slate-800/50 hover:bg-slate-700 transition">
                                <div class="w-8 font-bold text-center text-slate-400">#${i+1}</div>
                                <div class="w-10 h-10 rounded-full bg-slate-600 flex items-center justify-center text-lg">${u.avatar||'üë§'}</div>
                                <div class="flex-1 font-bold text-white">${u.name}</div>
                                <div class="text-yellow-400 font-mono">${(u.xp||0).toLocaleString()} XP</div>
                            </div>
                        `).join('');
                    } catch(e) { box.innerHTML = '<div class="p-4 text-red-400">Failed to load</div>'; }
                },
                shop: async () => {
                    const box = document.getElementById('shop-items');
                    try {
                        const res = await fetch('/api/shop');
                        const data = await res.json();
                        box.innerHTML = data.map(item => `
                            <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 flex flex-col items-center text-center gap-2 hover:border-indigo-500 transition shadow-lg relative overflow-hidden group">
                                <div class="absolute inset-0 bg-blue-500/5 group-hover:bg-blue-500/10 transition"></div>
                                <div class="text-4xl mb-2 bg-slate-900 p-2 rounded-lg">${item.icon}</div>
                                <h4 class="font-bold text-white relative z-10">${item.name}</h4>
                                <div class="text-yellow-400 font-bold relative z-10">ü™ô ${item.price}</div>
                                <button onclick="Game.api.buy(${item.id})" class="w-full py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold rounded-lg mt-2 shadow-md active:scale-95 transition relative z-10">Buy Now</button>
                            </div>
                        `).join('');
                    } catch(e) {}
                    
                    const invRes = await fetch(`/api/inventory?userId=${sessionStorage.getItem('user_id')}`);
                    const invData = await invRes.json();
                    const invBox = document.getElementById('user-inventory');
                    if (invData.length) {
                        invBox.innerHTML = invData.map(i => `<div class="flex gap-2 items-center p-2 bg-slate-700/50 rounded mb-2 border border-slate-600"><span class="text-lg">${i.icon}</span> <span class="text-slate-300 text-xs">${i.name}</span></div>`).join('');
                    } else {
                        invBox.innerText = "No items yet.";
                    }
                }
            },

            ai: {
                toggle: () => {
                    const win = document.getElementById('ai-window');
                    win.classList.toggle('hidden');
                },
                send: async () => {
                    const inp = document.getElementById('ai-input');
                    const msg = inp.value.trim();
                    if(!msg) return;
                    
                    const box = document.getElementById('ai-chat-box');
                    box.innerHTML += `<div class="text-right mb-2"><span class="bg-indigo-600 text-white px-3 py-2 rounded-lg inline-block rounded-tr-none text-xs">${msg}</span></div>`;
                    inp.value = ''; box.scrollTop = box.scrollHeight;

                    try {
                        const res = await fetch('/api/chat', { 
                            method: 'POST', 
                            headers: {'Content-Type':'application/json'},
                            body: JSON.stringify({ message: msg, userContext: Game.data.user }) 
                        });
                        const data = await res.json();
                        const reply = data.success ? data.reply : (data.error || "AI Offline");
                        
                        box.innerHTML += `<div class="text-left mb-2"><span class="bg-slate-700 text-slate-200 px-3 py-2 rounded-lg inline-block rounded-tl-none text-xs">ü§ñ ${reply}</span></div>`;
                        box.scrollTop = box.scrollHeight;
                    } catch(e) {
                        box.innerHTML += `<div class="text-left mb-2"><span class="text-red-400 text-xs">Connection Failed</span></div>`;
                    }
                }
            }
        };

        document.addEventListener('DOMContentLoaded', Game.init);
    </script>
</body>
</html>