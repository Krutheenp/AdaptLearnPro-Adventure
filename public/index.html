<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdaptLearn Adventure - The Knowledge Quest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&amp;display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #1a1a2e; color: #e2e8f0; } /* Dark Theme Base */
        .btn-game { 
            background: linear-gradient(to bottom, #f59e0b, #d97706); border: 2px solid #78350f; 
            box-shadow: 0 4px 0 #78350f; color: white; text-shadow: 1px 1px 0 #78350f;
            transition: all 0.1s;
        }
        .btn-game:active { transform: translateY(4px); box-shadow: 0 0 0 #78350f; }
        .glass-panel { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(8px); border: 2px solid rgba(255,255,255,0.1); border-radius: 1rem; }
        .map-path { stroke: #6366f1; stroke-width: 4; stroke-dasharray: 10; animation: dash 20s linear infinite; }
        @keyframes dash { to { stroke-dashoffset: 1000; } }
        @keyframes bob { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .avatar-bob { animation: bob 3s ease-in-out infinite; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        .animate-zoom-in { animation: zoomIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>

<body class="bg-slate-900 min-h-screen bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
    
    <!-- Top Bar (Game HUD) -->
    <header class="fixed top-0 w-full z-50 p-4 pointer-events-none">
        <div class="max-w-7xl mx-auto flex justify-between items-start pointer-events-auto">
            <!-- Left: Player Info -->
            <div class="flex items-center gap-4 bg-slate-800/90 p-2 pr-6 rounded-full border-2 border-slate-600 shadow-xl" id="hudPlayer" style="display:none">
                <div class="w-14 h-14 bg-indigo-600 rounded-full flex items-center justify-center text-3xl border-2 border-white shadow-inner" id="hudAvatar">üôÇ</div>
                <div>
                    <div class="font-bold text-white leading-tight" id="hudName">Player</div>
                    <div class="text-xs text-indigo-300 font-bold">Lv.<span id="hudLevel">1</span></div>
                    <!-- XP Bar -->
                    <div class="w-24 h-2 bg-slate-700 rounded-full mt-1 overflow-hidden">
                        <div id="hudXP" class="h-full bg-gradient-to-r from-blue-400 to-indigo-500 w-0"></div>
                    </div>
                </div>
            </div>

            <!-- Center: App Logo (Click to Reload) -->
            <div class="cursor-pointer group" onclick="location.reload()">
                <h1 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 drop-shadow-sm group-hover:scale-110 transition">AdaptLearn Adventure</h1>
            </div>

            <!-- Right: Resources -->
            <div class="flex gap-3" id="hudResources" style="display:none">
                <div class="flex items-center gap-2 bg-slate-800/90 px-4 py-2 rounded-full border-2 border-yellow-600 shadow-lg">
                    <span class="text-xl">ü™ô</span> <span class="font-bold text-yellow-400 font-mono text-lg" id="hudCoins">0</span>
                </div>
                <div class="flex items-center gap-2 bg-slate-800/90 px-4 py-2 rounded-full border-2 border-orange-600 shadow-lg">
                    <span class="text-xl">üî•</span> <span class="font-bold text-orange-400 font-mono text-lg" id="hudStreak">0</span>
                </div>
                <button onclick="AdaptLearnPro.ui.switchTab('dashboard')" class="bg-indigo-600 hover:bg-indigo-500 text-white p-2 rounded-full w-10 h-10 flex items-center justify-center border-2 border-indigo-400 shadow-lg transition" title="Lobby">üè†</button>
                
                <!-- Profile/Logout Dropdown -->
                <div class="relative group">
                    <button class="bg-slate-700 hover:bg-slate-600 text-white p-2 rounded-full w-10 h-10 flex items-center justify-center border-2 border-slate-500 shadow-lg transition">‚öôÔ∏è</button>
                    <div class="absolute right-0 mt-2 w-48 bg-slate-800 border border-slate-600 rounded-xl shadow-xl hidden group-hover:block overflow-hidden z-50">
                        <a href="/admin.html" id="linkAdmin" class="hidden px-4 py-3 hover:bg-slate-700 text-sm font-bold text-yellow-400 border-b border-slate-700">üõ†Ô∏è Instructor Studio</a>
                        <a href="/profile.html" class="block px-4 py-3 hover:bg-slate-700 text-sm font-bold text-white">üë§ Profile</a>
                        <button onclick="AdaptLearnPro.auth.logout()" class="block w-full text-left px-4 py-3 hover:bg-red-900/50 text-red-400 text-sm font-bold border-t border-slate-700">üö™ Logout</button>
                    </div>
                </div>
            </div>
            
            <!-- Login Btn if guest -->
            <div id="hudGuest">
                <a href="/login.html" class="btn-game px-6 py-2 rounded-xl font-bold">Login to Play</a>
            </div>
        </div>
    </header>

    <!-- Leaderboard Button (Left Side Fixed) -->
    <button onclick="AdaptLearnPro.leaderboard.open()" class="fixed left-6 top-24 w-14 h-14 bg-yellow-500 hover:bg-yellow-400 text-slate-900 rounded-full shadow-xl border-4 border-yellow-700 flex items-center justify-center text-3xl z-40 transition transform hover:scale-110 active:scale-95" title="Leaderboard">
        üèÜ
    </button>

    <!-- Shop Button (Left Side Fixed - Below Leaderboard) -->
    <button onclick="AdaptLearnPro.shop.open()" class="fixed left-6 top-44 w-14 h-14 bg-blue-600 hover:bg-blue-500 text-white rounded-full shadow-xl border-4 border-blue-800 flex items-center justify-center text-3xl z-40 transition transform hover:scale-110 active:scale-95" title="Item Shop">
        üõí
    </button>

    <div class="pt-24 pb-12 px-4 max-w-7xl mx-auto">
        
        <!-- DASHBOARD (LOBBY) -->
        <div id="dashboard-content" class="tab-content hidden animate-zoom-in">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                
                <!-- Main Character Showcase -->
                <div class="lg:col-span-5 flex flex-col items-center justify-center min-h-[50vh] relative">
                    <div class="absolute inset-0 bg-indigo-500/10 blur-[100px] rounded-full"></div>
                    
                    <!-- Avatar -->
                    <div class="relative avatar-bob group cursor-pointer" onclick="location.href='/profile.html'">
                        <div class="w-64 h-64 bg-gradient-to-b from-slate-700 to-slate-800 rounded-3xl border-4 border-slate-600 shadow-2xl flex items-center justify-center text-[10rem] relative z-10 group-hover:border-indigo-400 transition transform group-hover:scale-105">
                            <span id="lobbyAvatar">üôÇ</span>
                        </div>
                        <div class="absolute -bottom-6 left-1/2 -translate-x-1/2 bg-slate-900 px-6 py-2 rounded-xl border border-slate-600 whitespace-nowrap z-20 shadow-lg">
                            <span class="text-slate-400 text-xs uppercase font-bold tracking-widest block text-center mb-1">Class</span>
                            <span class="text-indigo-400 font-bold text-lg" id="lobbyRole">Novice</span>
                        </div>
                    </div>

                    <!-- Daily Quest Board -->
                    <div class="mt-16 w-full max-w-md glass-panel p-6 transform -rotate-1 hover:rotate-0 transition duration-300 relative">
                        <div class="absolute -top-3 -right-3 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-lg animate-bounce">NEW!</div>
                        <h3 class="text-yellow-400 font-bold text-lg mb-4 flex items-center gap-2">üìú Daily Quests</h3>
                        <div class="space-y-3">
                            <div class="bg-slate-800/50 p-3 rounded-lg flex items-center justify-between border border-slate-700 hover:bg-slate-700/50 transition">
                                <div class="flex items-center gap-3">
                                    <div class="w-6 h-6 rounded-full border border-green-500 bg-green-500/20 text-green-500 flex items-center justify-center text-xs shadow-[0_0_10px_rgba(34,197,94,0.4)]">‚úì</div>
                                    <span class="text-sm text-slate-300 font-medium">Daily Login</span>
                                </div>
                                <span class="text-xs font-bold text-yellow-500 bg-yellow-900/30 px-2 py-1 rounded border border-yellow-700">+10 ü™ô</span>
                            </div>
                            <div class="bg-slate-800/50 p-3 rounded-lg flex items-center justify-between border border-slate-700 hover:bg-slate-700/50 transition">
                                <div class="flex items-center gap-3">
                                    <div class="w-6 h-6 rounded-full border border-slate-500 bg-slate-800"></div>
                                    <span class="text-sm text-slate-300 font-medium">Complete 1 Mission</span>
                                </div>
                                <span class="text-xs font-bold text-yellow-500 bg-yellow-900/30 px-2 py-1 rounded border border-yellow-700">+50 ü™ô</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Adventure Map -->
                <div class="lg:col-span-7 relative">
                    <h2 class="text-3xl font-black text-white mb-6 drop-shadow-md flex items-center gap-3">
                        <span>üó∫Ô∏è</span> <span class="text-sm font-normal text-slate-400 bg-slate-800 px-3 py-1 rounded-lg border border-slate-700">Zone Selection</span>
                    </h2>
                    
                    <div class="relative min-h-[600px] bg-slate-800/50 rounded-3xl border-4 border-slate-700 p-8 shadow-inner overflow-hidden custom-scrollbar" id="mapContainer">
                        <!-- SVG Path Layer -->
                        <svg class="absolute inset-0 w-full h-full pointer-events-none z-0" id="mapLines"></svg>
                        
                        <!-- Nodes generated by JS -->
                        <div id="mapNodes" class="relative z-10 h-full w-full"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ACTIVITIES (Fallback List - Redirected) -->
        <div id="activities-content" class="tab-content hidden">
            <div class="text-center py-20">
                <h2 class="text-2xl font-bold text-slate-400">Loading Map...</h2>
            </div>
        </div>

        <!-- AI TUTOR (Floating) -->
        <div id="ai-tutor-content" class="tab-content hidden animate-zoom-in">
             <div class="max-w-2xl mx-auto bg-slate-800 rounded-2xl shadow-2xl border border-slate-700 h-[70vh] flex flex-col overflow-hidden">
                <div class="p-4 bg-slate-900 border-b border-slate-700 flex justify-between items-center">
                    <h2 class="font-bold text-indigo-400 flex items-center gap-2 text-lg">ü§ñ AI Game Master</h2>
                    <button onclick="AdaptLearnPro.ui.switchTab('dashboard')" class="text-slate-400 hover:text-white transition bg-slate-700 rounded-full w-8 h-8 flex items-center justify-center">‚úï</button>
                </div>
                <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-800/50 scroll-smooth">
                    <!-- Intro -->
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center text-white shadow-lg border border-indigo-400">ü§ñ</div>
                        <div class="bg-slate-700 p-4 rounded-2xl rounded-tl-none shadow-sm border border-slate-600 text-slate-200 text-sm max-w-md">
                            Welcome, Traveler! I am your AI Guide. How can I assist you on your journey today?
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-slate-900 border-t border-slate-700 flex gap-2 relative z-10">
                    <input id="chatInput" type="text" class="flex-1 bg-slate-800 text-white border border-slate-600 rounded-xl px-4 py-3 outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition shadow-inner" placeholder="Ask for hints or guidance...">
                    <button onclick="AdaptLearnPro.ai.send()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded-xl font-bold shadow-lg transition transform active:scale-95">Send</button>
                </div>
             </div>
        </div>

    </div>

    <!-- Floating Action Button for AI -->
    <button id="aiFloatingBtn" onclick="AdaptLearnPro.ui.switchTab('ai-tutor')" class="fixed bottom-8 right-8 w-16 h-16 bg-indigo-600 hover:bg-indigo-50 text-white rounded-full shadow-2xl flex items-center justify-center text-3xl z-40 border-4 border-slate-800 hover:scale-110 transition animate-bounce" title="Open AI Chat" style="display:none">
        ü§ñ
    </button>

    <!-- Learning Player Modal -->
    <div id="learningModal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 w-full max-w-6xl h-[90vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden animate-zoom-in border border-slate-700">
            <div class="bg-slate-800 px-6 py-4 flex justify-between items-center border-b border-slate-700">
                <div>
                    <h2 class="font-bold text-xl text-indigo-400" id="lm-title">Mission Title</h2>
                    <p class="text-xs text-slate-400 font-mono mt-1" id="lm-progress">Loading...</p>
                </div>
                <button onclick="AdaptLearnPro.player.close()" class="w-10 h-10 rounded-full bg-slate-700 hover:bg-red-500 hover:text-white flex items-center justify-center transition border border-slate-600">‚úï</button>
            </div>
            <div class="flex-1 flex overflow-hidden">
                <div class="w-72 bg-slate-800/50 border-r border-slate-700 overflow-y-auto p-4 hidden md:block" id="lm-sidebar"></div>
                <div class="flex-1 p-8 overflow-y-auto bg-slate-900 flex flex-col items-center custom-scrollbar" id="lm-content"></div>
            </div>
            <div class="bg-slate-800 border-t border-slate-700 px-6 py-4 flex justify-between items-center">
                <button onclick="AdaptLearnPro.player.prev()" class="px-6 py-2.5 bg-slate-700 text-slate-300 rounded-xl font-bold hover:bg-slate-600 disabled:opacity-50 transition" id="lm-prev">‚Üê Back</button>
                <button onclick="AdaptLearnPro.player.next()" class="btn-game px-8 py-2.5 rounded-xl font-bold shadow-lg" id="lm-next">Next ‚Üí</button>
            </div>
        </div>
    </div>

    <script>
        const AdaptLearnPro = {
            data: { activities: [], progress: [], user: null, currentWorld: null },
            
            init: {
                run: async () => {
                    AdaptLearnPro.auth.check();
                    await AdaptLearnPro.api.fetchAll();
                    
                    AdaptLearnPro.init.listeners();
                    
                    if(AdaptLearnPro.data.user) {
                        AdaptLearnPro.render.nav();
                        AdaptLearnPro.render.dashboard();
                        AdaptLearnPro.ui.switchTab('dashboard');
                    } else {
                        AdaptLearnPro.render.nav();
                        // Guest mode
                        document.getElementById('dashboard-content').classList.remove('hidden');
                        document.getElementById('mapNodes').innerHTML = '<div class="text-center text-slate-500 mt-20">Please Login to Start Your Adventure</div>';
                    }
                },
                listeners: () => {
                    const inp = document.getElementById('chatInput');
                    if(inp) {
                        inp.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') AdaptLearnPro.ai.send();
                        });
                    }
                }
            },

            auth: {
                check: () => {
                    const auth = sessionStorage.getItem('user_id');
                    if(auth) {
                        AdaptLearnPro.data.user = {
                            id: sessionStorage.getItem('user_id'),
                            name: sessionStorage.getItem('user_name'),
                            role: sessionStorage.getItem('user_role'),
                            level: sessionStorage.getItem('user_level') || 1,
                            xp: sessionStorage.getItem('user_xp') || 0,
                            avatar: 'üôÇ',
                            coins: 0,
                            streak: 0
                        };
                    }
                },
                logout: () => {
                    sessionStorage.clear();
                    window.location.reload();
                }
            },

            ui: {
                switchTab: (tab) => {
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    const target = document.getElementById(tab + '-content');
                    if(target) target.classList.remove('hidden');
                    
                    if(tab === 'dashboard' && AdaptLearnPro.data.user) {
                        AdaptLearnPro.render.dashboard();
                    }
                },
                openProfileEdit: () => window.location.href = '/profile.html',
                selectWorld: (category) => {
                    AdaptLearnPro.data.currentWorld = category;
                    AdaptLearnPro.render.dashboard();
                },
                backToWorlds: () => {
                    AdaptLearnPro.data.currentWorld = null;
                    AdaptLearnPro.render.dashboard();
                }
            },

            api: {
                fetchAll: async () => {
                    try {
                        const acts = await fetch('/api/activities').then(r=>r.json());
                        AdaptLearnPro.data.activities = acts;
                        
                        if(AdaptLearnPro.data.user) {
                            const progData = await fetch(`/api/analytics?userId=${AdaptLearnPro.data.user.id}`).then(r=>r.json());
                            AdaptLearnPro.data.progress = progData;
                            
                            if(progData.user) {
                                AdaptLearnPro.data.user = { 
                                    ...AdaptLearnPro.data.user, 
                                    ...progData.user,
                                    coins: progData.user.coins !== undefined ? progData.user.coins : 0,
                                    streak: progData.user.streak !== undefined ? progData.user.streak : 0
                                };
                                AdaptLearnPro.render.nav();
                            }
                        } else {
                            AdaptLearnPro.data.progress = { activities: [] }; 
                        }
                    } catch (e) { console.error(e); }
                },
                saveProgress: async (actId, score, status) => {
                    if(!AdaptLearnPro.data.user) return;
                    await fetch('/api/progress', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ userId: AdaptLearnPro.data.user.id, activityId: actId, score, status })
                    });
                    await AdaptLearnPro.api.fetchAll();
                    AdaptLearnPro.render.dashboard();
                }
            },

            render: {
                nav: () => {
                    const user = AdaptLearnPro.data.user;
                    if(user) {
                        document.getElementById('hudPlayer').style.display = 'flex';
                        document.getElementById('hudResources').style.display = 'flex';
                        document.getElementById('hudGuest').style.display = 'none';
                        document.getElementById('aiFloatingBtn').style.display = 'flex';
                        document.getElementById('hudName').innerText = user.name;
                        document.getElementById('hudLevel').innerText = user.level || 1;
                        document.getElementById('hudAvatar').innerText = user.avatar || 'üôÇ';
                        document.getElementById('hudCoins').innerText = (user.coins !== undefined && user.coins !== null) ? user.coins : 0;
                        document.getElementById('hudStreak').innerText = (user.streak !== undefined && user.streak !== null) ? user.streak : 0;
                        
                        const nextXP = (user.level || 1) * 100;
                        const pct = Math.min(((user.xp || 0) / nextXP) * 100, 100);
                        document.getElementById('hudXP').style.width = pct + '%';

                        // Show Admin Link
                        if(user.role === 'admin' || user.role === 'teacher') {
                            document.getElementById('linkAdmin').classList.remove('hidden');
                            document.getElementById('linkAdmin').classList.add('block');
                        }
                    } else {
                        document.getElementById('hudPlayer').style.display = 'none';
                        document.getElementById('hudResources').style.display = 'none';
                        document.getElementById('hudGuest').style.display = 'block';
                        document.getElementById('aiFloatingBtn').style.display = 'none';
                    }
                },
                dashboard: () => {
                    const u = AdaptLearnPro.data.user;
                    if(!u) return;
                    
                    document.getElementById('lobbyAvatar').innerText = u.avatar || 'üôÇ';
                    document.getElementById('lobbyRole').innerText = u.role || 'Novice';
                    
                    const mapTitle = document.querySelector('#dashboard-content h2'); 
                    
                    if (AdaptLearnPro.data.currentWorld) {
                        if(mapTitle) {
                            mapTitle.innerHTML = `
                                <button onclick="AdaptLearnPro.ui.backToWorlds()" class="mr-3 text-white hover:text-yellow-400 transition bg-slate-800 rounded-full w-10 h-10 text-xl border border-slate-600">‚¨ÖÔ∏è</button>
                                <span>üó∫Ô∏è</span> ${AdaptLearnPro.data.currentWorld} <span class="text-sm font-normal text-slate-400 bg-slate-800 px-3 py-1 rounded-lg border border-slate-700 ml-2">Zone Map</span>
                            `;
                        }
                        AdaptLearnPro.map.render(AdaptLearnPro.data.currentWorld);
                    } else {
                        if(mapTitle) mapTitle.innerHTML = `<span>üåå</span> Galactic Map <span class="text-sm font-normal text-slate-400 bg-slate-800 px-3 py-1 rounded-lg border border-slate-700 ml-2">Select a Subject</span>`;
                        AdaptLearnPro.render.worlds();
                    }
                },
                worlds: () => {
                    const acts = AdaptLearnPro.data.activities;
                    const prog = AdaptLearnPro.data.progress.activities || [];
                    const container = document.getElementById('mapNodes');
                    const svg = document.getElementById('mapLines');
                    if(!container || !svg) return;
                    
                    container.innerHTML = ''; svg.innerHTML = '';
                    document.getElementById('mapContainer').style.background = 'radial-gradient(circle at center, #0f172a 0%, #020617 100%)'; 

                    const categories = [...new Set(acts.map(a => a.category || 'General'))];
                    
                    categories.forEach((cat, i) => {
                        const catActs = acts.filter(a => (a.category||'General') === cat);
                        const completedCount = catActs.filter(a => prog.find(p => p.activity_id === a.id && p.status === 'completed')).length;
                        const totalCredits = catActs.reduce((s, a) => s + (a.credits||1), 0);
                        const earnedCredits = catActs.filter(a => prog.find(p => p.activity_id === a.id && p.status === 'completed')).reduce((s, a) => s + (a.credits||1), 0);

                        const row = Math.floor(i / 2);
                        const col = i % 2;
                        
                        const planet = document.createElement('div');
                        planet.className = `absolute w-48 h-48 rounded-full border-4 border-slate-600 flex flex-col items-center justify-center cursor-pointer transition transform hover:scale-110 hover:border-indigo-400 z-20 shadow-2xl bg-gradient-to-br from-slate-700 to-slate-900 group`;
                        
                        planet.style.top = `${50 + (row * 220)}px`;
                        planet.style.left = col === 0 ? '20%' : '60%';
                        
                        const icons = { 'Mathematics': 'üìê', 'Science': 'üß™', 'English': 'üìö', 'Technology': 'üíª', 'General': 'üåç' };
                        planet.innerHTML = `
                            <div class="text-6xl mb-2 group-hover:animate-bounce filter drop-shadow-lg">${icons[cat] || 'ü™ê'}</div>
                            <div class="font-bold text-white text-lg">${cat}</div>
                            <div class="text-xs text-slate-400 mt-1 font-mono bg-slate-800/80 px-2 py-0.5 rounded">${completedCount}/${catActs.length} Missions</div>
                            <div class="text-xs text-yellow-400 font-bold mt-1">‚≠ê ${earnedCredits}/${totalCredits} Credits</div>
                        `;
                        
                        planet.onclick = () => AdaptLearnPro.ui.selectWorld(cat);
                        container.appendChild(planet);
                    });
                    
                    container.style.height = `${(Math.ceil(categories.length/2) * 220) + 100}px`;
                },
                recommendation: () => {}, 
                progressReport: () => {},
                activities: () => {} 
            },
            
            map: {
                render: (category) => {
                    const allActs = AdaptLearnPro.data.activities;
                    const acts = allActs.filter(a => (a.category || 'General') === category);
                    const prog = AdaptLearnPro.data.progress.activities || [];
                    const container = document.getElementById('mapNodes');
                    const svg = document.getElementById('mapLines');
                    if(!container || !svg) return;
                    
                    container.innerHTML = ''; svg.innerHTML = '';

                    const islandGroups = [];
                    const chunkSize = 3; 
                    for(let i=0; i<acts.length; i+=chunkSize) islandGroups.push(acts.slice(i, i+chunkSize));

                    islandGroups.forEach((group, gIdx) => {
                        const startY = 50 + (gIdx * chunkSize * 150);
                        const height = (group.length * 150) + 100;
                        const island = document.createElementNS("http://www.w3.org/2000/svg", "path");
                        const width = 600 + Math.random() * 100;
                        const x = 50 + Math.random() * 20;
                        const d = `M ${x} ${startY} Q ${x-50} ${startY + height/2} ${x+20} ${startY + height} Q ${x+width/2} ${startY + height + 20} ${x+width} ${startY + height - 20} Q ${x+width+50} ${startY + height/2} ${x+width-20} ${startY} Z`;
                        island.setAttribute("d", d);
                        island.setAttribute("fill", "#1e293b"); island.setAttribute("stroke", "#334155"); island.setAttribute("stroke-width", "3");
                        svg.appendChild(island);
                        
                        for(let k=0; k<5; k++) {
                            const decor = document.createElementNS("http://www.w3.org/2000/svg", "text");
                            decor.setAttribute("x", x + 50 + Math.random() * (width-100));
                            decor.setAttribute("y", startY + 50 + Math.random() * (height-100));
                            decor.setAttribute("font-size", "20"); decor.setAttribute("opacity", "0.3");
                            decor.textContent = Math.random() > 0.5 ? 'üå≤' : '‚õ∞Ô∏è';
                            svg.appendChild(decor);
                        }
                    });

                    acts.forEach((act, i) => {
                        const isDone = prog.find(p => p.activity_id === act.id && p.status === 'completed');
                        const isLocked = i > 0 && !prog.find(p => p.activity_id === acts[i-1].id && p.status === 'completed');
                        
                        const top = 100 + (i * 150);
                        const positions = ['20%', '50%', '80%', '50%'];
                        const leftPos = positions[i % 4];
                        
                        const node = document.createElement('div');
                        node.id = `node-${i}`;
                        node.className = `absolute w-20 h-20 rounded-2xl border-4 flex flex-col items-center justify-center cursor-pointer transition transform hover:scale-110 z-20 shadow-[0_10px_20px_rgba(0,0,0,0.5)] 
                            ${isLocked ? 'bg-slate-700 border-slate-600 grayscale opacity-80' : (isDone ? 'bg-emerald-600 border-emerald-400 ring-4 ring-emerald-900/50' : 'bg-amber-500 border-amber-300 animate-bounce-slow ring-4 ring-amber-900/50')}`;
                        node.style.top = `${top}px`;
                        node.style.left = leftPos;
                        
                        // Icon & Credit Badge & Rating
                        const icon = act.type==='video'?'üìú':(act.type==='game'?'üéÆ':'üß™');
                        const stars = act.rating ? `‚≠ê${parseFloat(act.rating).toFixed(1)}` : '';
                        
                        node.innerHTML = `
                            <span class="text-2xl filter drop-shadow-md">${isLocked ? 'üîí' : icon}</span>
                            ${!isLocked ? `<span class="absolute -top-3 -right-3 bg-blue-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full border border-blue-400 shadow">‚≠ê${act.credits||1}</span>` : ''}
                            ${!isLocked && stars ? `<span class="absolute -bottom-3 -right-3 bg-yellow-500 text-slate-900 text-[10px] font-bold px-1.5 py-0.5 rounded-full border border-yellow-400 shadow">${stars}</span>` : ''}
                        `;
                        
                        const label = document.createElement('div');
                        label.className = `absolute -bottom-10 left-1/2 -translate-x-1/2 whitespace-nowrap text-xs font-bold px-3 py-1.5 rounded-lg bg-slate-900 text-white border border-slate-600 z-30 shadow-xl pointer-events-none`;
                        label.innerText = (i+1) + ". " + act.title;
                        node.appendChild(label);

                        node.onclick = () => {
                            if(isLocked) alert('üîí Complete previous missions to unlock!');
                            else AdaptLearnPro.player.openById(act.id);
                        };

                        container.appendChild(node);

                        if(i > 0) {
                            const prevPos = positions[(i-1)%4];
                            const conW = container.offsetWidth || 800;
                            const x1 = (parseFloat(prevPos)/100) * conW + 40;
                            const y1 = (100 + ((i-1) * 150)) + 40;
                            const x2 = (parseFloat(leftPos)/100) * conW + 40;
                            const y2 = top + 40;
                            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                            const cx = (x1 + x2) / 2 + (i%2===0 ? 50 : -50);
                            const cy = (y1 + y2) / 2;
                            const d = `M ${x1} ${y1} Q ${cx} ${cy} ${x2} ${y2}`;
                            path.setAttribute("d", d); path.setAttribute("fill", "none");
                            path.setAttribute("stroke", isLocked ? "#475569" : "#fbbf24");
                            path.setAttribute("stroke-width", "6");
                            path.setAttribute("stroke-dasharray", isLocked ? "10,10" : "15,10");
                            path.setAttribute("stroke-linecap", "round");
                            path.setAttribute("class", "map-path");
                            svg.appendChild(path);
                        }
                    });
                    
                    container.style.height = `${(acts.length * 150) + 300}px`;
                    document.getElementById('mapContainer').style.background = `radial-gradient(circle at center, #0f172a 0%, #020617 100%), url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4wNSkiLz48L3N2Zz4=')`;
                },
                // ... (Player methods can be reused/unchanged) ...
            },

            player: {
                currentCourse: null, currentUnitIdx: 0, content: [],
                openById: (id) => {
                    const course = AdaptLearnPro.data.activities.find(a => a.id === id);
                    if(!course) return;
                    AdaptLearnPro.player.currentCourse = course;
                    AdaptLearnPro.player.currentUnitIdx = 0;
                    try { AdaptLearnPro.player.content = typeof course.content === 'string' ? JSON.parse(course.content) : (course.content || []); } catch(e) { AdaptLearnPro.player.content = []; }
                    document.getElementById('learningModal').classList.remove('hidden');
                    AdaptLearnPro.player.render();
                },
                close: () => document.getElementById('learningModal').classList.add('hidden'),
                render: () => {
                    const { currentCourse, currentUnitIdx, content } = AdaptLearnPro.player;
                    document.getElementById('lm-title').innerText = currentCourse.title;
                    const percent = Math.round(((currentUnitIdx + 1) / content.length) * 100);
                    document.getElementById('lm-progress').innerText = `Stage ${currentUnitIdx+1}/${content.length} ‚Ä¢ ${percent}%`;
                    
                    document.getElementById('lm-sidebar').innerHTML = content.map((u, i) => `
                        <div class="p-3 rounded-lg mb-2 cursor-pointer transition flex items-center gap-3 ${i===currentUnitIdx ? 'bg-indigo-600 text-white shadow-lg border border-indigo-400' : 'text-slate-400 hover:bg-slate-700 hover:text-white'}" onclick="AdaptLearnPro.player.jump(${i})">
                            <div class="w-6 h-6 rounded flex items-center justify-center text-xs font-bold ${i===currentUnitIdx?'bg-white/20':'bg-slate-700 border border-slate-600'}">${i+1}</div>
                            <div class="text-sm font-medium truncate">${u.title || 'Stage ' + (i+1)}</div>
                        </div>`).join('');

                    if(content.length===0) { document.getElementById('lm-content').innerHTML = "<div class='text-slate-500'>No Content</div>"; return; }
                    
                    const unit = content[currentUnitIdx];
                    let html = `<div class="w-full max-w-4xl animate-zoom-in space-y-8 pb-12">`;
                    html += `<h2 class="text-3xl font-bold text-white border-b border-slate-700 pb-4">${unit.title || 'Mission Brief'}</h2>`;

                    if (unit.blocks && unit.blocks.length > 0) {
                        html += unit.blocks.map((b, bIdx) => {
                            if (b.type === 'text') return `<div class="prose prose-invert lg:prose-xl text-slate-300 leading-relaxed">${b.content}</div>`;
                            
                            if (b.type === 'video') {
                                if (b.url.includes('youtube') || b.url.includes('youtu.be')) {
                                    const videoId = b.url.split('v=')[1]?.split('&')[0] || b.url.split('/').pop();
                                    return `<div class="aspect-video bg-black rounded-2xl overflow-hidden shadow-2xl ring-2 ring-slate-700"><iframe src="https://www.youtube.com/embed/${videoId}" class="w-full h-full" frameborder="0" allowfullscreen></iframe></div>`;
                                } else {
                                    return `<div class="aspect-video bg-black rounded-2xl overflow-hidden shadow-2xl ring-2 ring-slate-700"><video src="${b.url}" controls class="w-full h-full"></video></div>`;
                                }
                            }                                            
                            if (b.type === 'image') return `<div class="text-center"><img src="${b.url}" class="max-h-[60vh] mx-auto rounded-xl shadow-lg border border-slate-700"><p class="text-sm text-slate-500 mt-2 italic">${b.filename||''}</p></div>`;
                            
                            if (b.type === 'quiz') return `
                                <div class="bg-slate-800 border-4 border-slate-700 p-8 rounded-2xl shadow-2xl relative overflow-hidden text-center mt-8">
                                    <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-red-600 to-red-400"></div>
                                    
                                    <!-- Boss Visual -->
                                    <div class="mb-8 relative">
                                        <div class="w-32 h-32 mx-auto bg-slate-900 rounded-full border-4 border-red-500 flex items-center justify-center text-6xl animate-bounce shadow-[0_0_50px_rgba(220,38,38,0.4)] relative z-10">üëπ</div>
                                        <div class="w-64 h-6 bg-slate-900 rounded-full mx-auto mt-6 border-2 border-slate-600 overflow-hidden relative shadow-inner">
                                            <div class="h-full bg-gradient-to-r from-red-600 to-red-500 w-full transition-all duration-700 ease-out" id="boss-hp-${bIdx}"></div>
                                            <div class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-white tracking-widest uppercase shadow-sm">Boss Health</div>
                                        </div>
                                    </div>

                                    <h3 class="text-2xl font-bold text-white mb-8">${b.question}</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-3xl mx-auto">
                                        ${b.options.map((opt, i) => `
                                            <button onclick="AdaptLearnPro.player.checkBoss(this, ${i}, ${b.correct}, ${bIdx})" class="btn-game px-6 py-4 rounded-xl font-bold text-lg text-left relative overflow-hidden group" data-idx="${i}">
                                                <span class="relative z-10 group-hover:pl-2 transition-all duration-200">‚öîÔ∏è ${opt}</span>
                                            </button>`).join('')}
                                    </div>
                                    <div class="quiz-feedback hidden mt-8 p-6 rounded-xl font-bold text-xl animate-fade-in-up border-4 shadow-xl"></div>
                                </div>`;
                            return '';
                        }).join('');
                    } else {
                        // Fallback
                        html += `<div class="text-slate-400">Content format not supported.</div>`;
                    }

                    if(currentUnitIdx === content.length - 1) {
                         html += `<div class="mt-16 text-center border-t border-slate-700 pt-8"><button onclick="AdaptLearnPro.player.finishCourse()" class="btn-game px-12 py-5 bg-green-600 border-green-800 text-white font-bold rounded-2xl shadow-[0_10px_0_rgb(21,128,61)] text-2xl hover:translate-y-1 hover:shadow-[0_6px_0_rgb(21,128,61)] active:translate-y-3 active:shadow-none transition-all">‚ú® Complete Quest ‚ú®</button></div>`;
                    }
                    html += `</div>`;
                    document.getElementById('lm-content').innerHTML = html;
                    document.getElementById('lm-prev').disabled = currentUnitIdx === 0;
                    document.getElementById('lm-next').innerText = currentUnitIdx === content.length - 1 ? 'Finish' : 'Next ‚Üí';
                },
                jump: (i) => { AdaptLearnPro.player.currentUnitIdx = i; AdaptLearnPro.player.render(); },
                next: () => { if(AdaptLearnPro.player.currentUnitIdx < AdaptLearnPro.player.content.length-1) { AdaptLearnPro.player.currentUnitIdx++; AdaptLearnPro.player.render(); } },
                prev: () => { if(AdaptLearnPro.player.currentUnitIdx > 0) { AdaptLearnPro.player.currentUnitIdx--; AdaptLearnPro.player.render(); } },
                checkBoss: (btn, selected, correct, bIdx) => {
                    const parent = btn.closest('.bg-slate-800');
                    const feedback = parent.querySelector('.quiz-feedback');
                    const hpBar = document.getElementById(`boss-hp-${bIdx}`);
                    
                    parent.querySelectorAll('button').forEach(b => {
                        b.disabled = true;
                        b.classList.add('opacity-50', 'cursor-not-allowed');
                        if(parseInt(b.dataset.idx) === correct) b.classList.replace('opacity-50', 'ring-4 ring-green-400');
                    });
                    
                    feedback.classList.remove('hidden');
                    if(selected === correct) {
                        hpBar.style.width = '0%';
                        feedback.innerHTML = "üí• CRITICAL HIT! BOSS DEFEATED! üí•";
                        feedback.className = "quiz-feedback mt-8 p-6 rounded-xl font-bold text-xl animate-fade-in-up border-4 shadow-xl bg-green-900/80 border-green-500 text-green-300";
                    } else {
                        feedback.innerHTML = "üõ°Ô∏è BLOCKED! The Boss counters your attack! üíÄ";
                        feedback.className = "quiz-feedback mt-8 p-6 rounded-xl font-bold text-xl animate-fade-in-up border-4 shadow-xl bg-red-900/80 border-red-500 text-red-300";
                    }
                },
                finishCourse: async () => {
                    await AdaptLearnPro.api.saveProgress(AdaptLearnPro.player.currentCourse.id, 100, 'completed');
                    
                    // Show Rating Dialog
                    const container = document.getElementById('lm-content');
                    container.innerHTML = `
                        <div class="mt-8 text-center animate-zoom-in">
                            <h2 class="text-3xl font-bold text-yellow-400 mb-2">Quest Complete! üéâ</h2>
                            <p class="text-slate-400 mb-6">How was your experience?</p>
                            
                            <div class="flex justify-center gap-2 text-4xl mb-6" id="rating-stars">
                                ${[1,2,3,4,5].map(i => `<span class="cursor-pointer hover:scale-125 transition grayscale hover:grayscale-0" onclick="AdaptLearnPro.player.submitReview(${i})">‚≠ê</span>`).join('')}
                            </div>
                            
                            <button onclick="AdaptLearnPro.player.close()" class="text-slate-500 underline text-sm">Skip Rating</button>
                        </div>
                    `;
                },
                submitReview: async (rating) => {
                    await fetch('/api/reviews', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            user_id: AdaptLearnPro.data.user.id,
                            activity_id: AdaptLearnPro.player.currentCourse.id,
                            rating: rating,
                            comment: "Great course!"
                        })
                    });
                    alert('Thank you for your feedback! ‚≠ê');
                    AdaptLearnPro.player.close();
                    AdaptLearnPro.api.fetchAll(); // Refresh to update ratings on map
                }
            },

            ai: {
                // ... (ai logic remains same)
                history: [],
                send: async () => {
                    const inp = document.getElementById('chatInput'); 
                    const msg = inp.value.trim();
                    if(!msg) return;
                    
                    const box = document.getElementById('chatMessages');
                    box.innerHTML += `<div class="flex justify-end animate-fade-in-up"><div class="bg-indigo-600 text-white px-5 py-3 rounded-2xl rounded-tr-none shadow-md max-w-xs text-sm">${msg}</div></div>`;
                    inp.value = ''; box.scrollTop = box.scrollHeight;
                    
                    const loadingId = 'loading-' + Date.now();
                    box.innerHTML += `<div id="${loadingId}" class="flex items-start gap-3 animate-fade-in-up"><div class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center text-white text-sm shadow-md">ü§ñ</div><div class="bg-slate-700 px-5 py-3 rounded-2xl rounded-tl-none shadow-sm max-w-xs text-sm text-slate-400 italic">Thinking...</div></div>`;
                    box.scrollTop = box.scrollHeight;

                    try {
                        const res = await fetch('/api/chat', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ 
                                message: msg, 
                                history: AdaptLearnPro.ai.history,
                                userContext: AdaptLearnPro.data.user,
                                learningContext: AdaptLearnPro.data.progress
                            })
                        });
                        const data = await res.json();
                        document.getElementById(loadingId).remove();
                        const reply = data.success ? data.reply : "Error: " + data.error;
                        
                        box.innerHTML += `<div class="flex items-start gap-3 animate-fade-in-up"><div class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center text-white text-sm shadow-md">ü§ñ</div><div class="bg-slate-700 px-5 py-3 rounded-2xl rounded-tl-none shadow-sm max-w-xs text-sm text-slate-200 leading-relaxed">${reply}</div></div>`;
                        
                        if(data.success && !data.isSimulated) {
                            AdaptLearnPro.ai.history.push({ role: "user", parts: [{ text: msg }] });
                            AdaptLearnPro.ai.history.push({ role: "model", parts: [{ text: reply }] });
                        }
                    } catch (e) {
                        document.getElementById(loadingId).remove();
                    }
                    box.scrollTop = box.scrollHeight;
                }
            },

            leaderboard: {
                // ... (leaderboard logic remains same)
                open: async () => { /* ... */ }
            },

            shop: {
                open: async () => {
                    if(!AdaptLearnPro.data.user) { alert('Please Login to access the Shop'); return; }
                    document.getElementById('shopModal').classList.remove('hidden');
                    document.getElementById('shop-balance').innerText = AdaptLearnPro.data.user.coins || 0;
                    
                    await AdaptLearnPro.shop.fetchItems();
                    await AdaptLearnPro.shop.fetchInventory();
                },
                fetchItems: async () => {
                    const list = document.getElementById('shop-list');
                    list.innerHTML = '<div class="text-slate-500 col-span-2 text-center">Loading wares...</div>';
                    try {
                        const res = await fetch('/api/shop');
                        const items = await res.json();
                        list.innerHTML = items.map(item => `
                            <div class="bg-slate-800 border border-slate-700 rounded-2xl p-4 hover:border-blue-500 transition group relative overflow-hidden">
                                <div class="absolute inset-0 bg-blue-500/5 group-hover:bg-blue-500/10 transition"></div>
                                <div class="flex justify-between items-start mb-2 relative z-10">
                                    <div class="text-4xl bg-slate-900 rounded-xl w-14 h-14 flex items-center justify-center shadow-inner">${item.icon}</div>
                                    <span class="bg-slate-900 text-yellow-400 font-bold px-3 py-1 rounded-lg text-sm border border-slate-600 shadow-sm">ü™ô ${item.price}</span>
                                </div>
                                <h4 class="font-bold text-white relative z-10">${item.name}</h4>
                                <p class="text-xs text-slate-400 mb-4 h-8 relative z-10">${item.description}</p>
                                <button onclick="AdaptLearnPro.shop.buy(${item.id})" class="w-full py-2 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl shadow-lg transition active:scale-95 relative z-10">Buy Now</button>
                            </div>
                        `).join('');
                    } catch(e) { list.innerHTML = 'Error loading shop'; }
                },
                fetchInventory: async () => {
                    const list = document.getElementById('inventory-list');
                    try {
                        const res = await fetch(`/api/inventory?userId=${AdaptLearnPro.data.user.id}`);
                        const items = await res.json();
                        if(items.length === 0) {
                            list.innerHTML = '<div class="text-center text-slate-500 py-10 text-sm border-2 border-dashed border-slate-700 rounded-xl">Your backpack is empty.<br>Go buy something!</div>';
                            return;
                        }
                        list.innerHTML = items.map(item => `
                            <div class="flex items-center gap-3 bg-slate-700/50 p-3 rounded-xl border border-slate-600">
                                <div class="text-2xl">${item.icon}</div>
                                <div>
                                    <div class="font-bold text-slate-200 text-sm">${item.name}</div>
                                    <div class="text-[10px] text-slate-400 uppercase font-bold">${item.type}</div>
                                </div>
                            </div>
                        `).join('');
                    } catch(e) { console.error(e); }
                },
                buy: async (itemId) => {
                    if(!confirm('Confirm purchase?')) return;
                    try {
                        const res = await fetch('/api/shop/buy', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ userId: AdaptLearnPro.data.user.id, itemId })
                        });
                        const data = await res.json();
                        if(data.success) {
                            // Update Balance
                            AdaptLearnPro.data.user.coins = data.new_balance;
                            document.getElementById('shop-balance').innerText = data.new_balance;
                            document.getElementById('hudCoins').innerText = data.new_balance; // Update HUD
                            
                            // Refresh Inventory
                            await AdaptLearnPro.shop.fetchInventory();
                            alert('Purchase successful! Item added to inventory.');
                        } else {
                            alert('Purchase failed: ' + (data.error || 'Unknown error'));
                        }
                    } catch(e) { alert('Transaction failed'); }
                }
            }
        };
        document.addEventListener('DOMContentLoaded', AdaptLearnPro.init.run);
    </script>
</body>
</html>