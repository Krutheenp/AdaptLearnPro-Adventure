<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdaptLearn Adventure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #0f172a; color: #e2e8f0; overflow-x: hidden; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .nav-item.active { background-color: #1e293b; color: white; border-left: 4px solid #ef4444; }
        .animate-float { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .course-node:hover .node-icon { transform: scale(1.15) rotate(5deg); }
    </style>
</head>

<body class="bg-slate-950">

    <!-- APP LAYOUT -->
    <div id="app-layout" class="flex h-screen overflow-hidden">
        
        <!-- SIDEBAR -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-slate-900 border-r border-slate-800 flex flex-col z-50 transform -translate-x-full lg:translate-x-0 lg:static transition-transform duration-300 ease-in-out shadow-2xl">
            <div class="h-20 flex items-center px-6 border-b border-slate-800">
                <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white text-xl shadow-lg mr-3 shadow-indigo-900/20">üß†</div>
                <span class="font-black text-white text-lg tracking-tight">AdaptLearn</span>
            </div>

            <nav class="flex-1 p-4 space-y-1 overflow-y-auto custom-scrollbar">
                <button onclick="Game.ui.tab('dashboard')" class="w-full text-left px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 transition flex items-center gap-3 nav-item active" id="nav-dashboard">
                    <i class="fa-solid fa-map"></i><span class="font-bold text-sm">Adventure Map</span>
                </button>
                <button onclick="Game.ui.tab('leaderboard')" class="w-full text-left px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 transition flex items-center gap-3 nav-item" id="nav-leaderboard">
                    <i class="fa-solid fa-trophy"></i><span class="font-bold text-sm">Hall of Fame</span>
                </button>
                <button onclick="Game.ui.tab('shop')" class="w-full text-left px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 transition flex items-center gap-3 nav-item" id="nav-shop">
                    <i class="fa-solid fa-store"></i><span class="font-bold text-sm">Item Shop</span>
                </button>
                <div class="border-t border-slate-800 my-4"></div>
                <a href="/profile.html" class="w-full text-left px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 transition flex items-center gap-3 auth-only hidden">
                    <i class="fa-solid fa-user-astronaut"></i><span class="font-bold text-sm">My Profile</span>
                </a>
                
                <!-- Special Menus -->
                <a href="/instructor.html" id="menu-instructor" class="hidden w-full text-left px-4 py-3 rounded-xl text-yellow-500 hover:bg-yellow-500/10 transition flex items-center gap-3">
                    <i class="fa-solid fa-wand-magic-sparkles"></i><span class="font-bold text-sm">Instructor Studio</span>
                </a>
                <a href="/admin.html" id="menu-admin" class="hidden w-full text-left px-4 py-3 rounded-xl text-red-500 hover:bg-red-500/10 transition flex items-center gap-3">
                    <i class="fa-solid fa-shield-halved"></i><span class="font-bold text-sm">Admin Panel</span>
                </a>
            </nav>

            <div class="p-4 border-t border-slate-800" id="sidebar-footer">
                <!-- Logged in state -->
                <div id="auth-footer" class="hidden">
                    <button onclick="Game.auth.logout()" class="w-full py-3 text-red-400 font-bold flex items-center justify-center gap-2 hover:bg-red-500/10 rounded-xl transition">
                        <i class="fa-solid fa-right-from-bracket"></i><span>Logout</span>
                    </button>
                </div>
                <!-- Guest state -->
                <div id="guest-footer" class="">
                    <a href="/login.html" class="w-full py-3 bg-indigo-600 text-white font-bold flex items-center justify-center gap-2 rounded-xl transition shadow-lg hover:bg-indigo-500">
                        <i class="fa-solid fa-key"></i><span>Sign In</span>
                    </a>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col min-w-0 bg-slate-950 overflow-hidden relative">
            
            <!-- TOP NAVBAR -->
            <header class="h-16 lg:h-20 glass flex items-center justify-between px-4 lg:px-8 z-40 flex-shrink-0">
                <div class="flex items-center gap-4">
                    <button onclick="Game.ui.toggleSidebar()" class="lg:hidden w-10 h-10 flex items-center justify-center text-slate-400 text-xl"><i class="fa-solid fa-bars"></i></button>
                    <h2 class="text-xl lg:text-2xl font-black text-white truncate" id="page-title">World Map</h2>
                </div>
                
                <div class="flex items-center gap-2 lg:gap-6">
                    <div class="flex items-center gap-2 bg-slate-900/80 px-3 lg:px-4 py-1.5 lg:py-2 rounded-2xl border border-slate-800 shadow-lg">
                        <span class="text-lg lg:text-xl">ü™ô</span>
                        <span class="font-black text-yellow-400 text-sm lg:text-base" id="hud-coins">0</span>
                    </div>
                    <div id="hud-avatar" class="w-10 h-10 lg:w-12 lg:h-12 rounded-2xl bg-slate-800 flex items-center justify-center text-xl lg:text-2xl border border-slate-700 shadow-xl cursor-pointer" onclick="location.href='/profile.html'">üôÇ</div>
                </div>
            </header>

            <!-- CONTENT AREA -->
            <div class="flex-1 overflow-y-auto p-4 lg:p-10 custom-scrollbar relative" id="content-scroll">
                
                <!-- DASHBOARD (Adventure Map) -->
                <div id="view-dashboard" class="view-section space-y-10 max-w-7xl mx-auto">
                    
                    <!-- Welcome Hero -->
                    <div id="welcome-hero" class="relative p-8 lg:p-12 rounded-[3.5rem] bg-gradient-to-br from-indigo-950 via-slate-900 to-indigo-900/20 border border-white/10 shadow-2xl overflow-hidden">
                        <div class="absolute -top-24 -right-24 w-96 h-96 bg-indigo-600/10 blur-[120px] rounded-full"></div>
                        <div class="absolute -bottom-24 -left-24 w-64 h-64 bg-blue-600/10 blur-[100px] rounded-full"></div>
                        
                        <div class="relative z-10 flex flex-col md:flex-row items-center gap-8 lg:gap-16">
                            <div class="relative group">
                                <div class="absolute inset-0 bg-indigo-500 blur-2xl opacity-20 group-hover:opacity-40 transition duration-500"></div>
                                <div class="w-32 h-32 lg:w-44 lg:h-44 rounded-[3rem] bg-slate-800 flex items-center justify-center text-7xl lg:text-8xl border-4 border-indigo-500/50 shadow-2xl transform transition-transform group-hover:scale-105" id="dash-avatar">üôÇ</div>
                                <div class="absolute -bottom-2 -right-2 bg-indigo-600 text-white w-12 h-12 rounded-2xl flex items-center justify-center border-4 border-slate-900 font-black text-sm shadow-xl" id="dash-lvl-badge">1</div>
                            </div>
                            
                            <div class="flex-1 text-center md:text-left space-y-6">
                                <div>
                                    <div class="inline-flex items-center gap-2 px-3 py-1 bg-indigo-500/10 border border-indigo-500/20 rounded-full mb-3">
                                        <span class="w-2 h-2 bg-indigo-500 rounded-full animate-pulse"></span>
                                        <span class="text-[10px] font-black text-indigo-400 uppercase tracking-widest" id="dash-role">Guest Explorer</span>
                                    </div>
                                    <h2 class="text-4xl lg:text-6xl font-black text-white leading-tight">Welcome back, <br class="hidden lg:block"><span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 via-blue-400 to-indigo-300" id="dash-name">Scholar</span></h2>
                                </div>
                                
                                <div id="auth-stats" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-2xl">
                                    <div class="bg-white/5 backdrop-blur-md p-5 rounded-[2rem] border border-white/5 shadow-inner">
                                        <div class="flex justify-between items-end mb-3">
                                            <div class="flex flex-col">
                                                <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Experience Points</span>
                                                <span class="text-xl font-black text-white" id="dash-xp-txt">0 / 100 XP</span>
                                            </div>
                                            <div class="text-right">
                                                <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Target</span>
                                                <div class="text-indigo-400 font-black" id="dash-next-lvl">Level 2</div>
                                            </div>
                                        </div>
                                        <div class="h-2.5 bg-slate-950 rounded-full overflow-hidden p-0.5 border border-white/5">
                                            <div id="dash-xp-bar" class="h-full bg-gradient-to-r from-indigo-600 via-blue-500 to-indigo-400 rounded-full w-0 transition-all duration-1000 shadow-[0_0_15px_rgba(99,102,241,0.5)]"></div>
                                        </div>
                                    </div>
                                    <div class="flex gap-3">
                                        <div class="flex-1 bg-white/5 backdrop-blur-md p-5 rounded-[2rem] border border-white/5 flex flex-col items-center justify-center text-center">
                                            <span class="text-2xl mb-1">ü™ô</span>
                                            <span class="text-lg font-black text-yellow-400" id="dash-coins">0</span>
                                            <span class="text-[8px] font-black text-slate-500 uppercase tracking-widest">Balance</span>
                                        </div>
                                        <div class="flex-1 bg-white/5 backdrop-blur-md p-5 rounded-[2rem] border border-white/5 flex flex-col items-center justify-center text-center">
                                            <span class="text-2xl mb-1">üèÜ</span>
                                            <span class="text-lg font-black text-blue-400" id="dash-certs">0</span>
                                            <span class="text-[8px] font-black text-slate-500 uppercase tracking-widest">Awards</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="guest-msg" class="inline-flex items-center gap-4 bg-white/5 border border-white/10 px-8 py-5 rounded-[2rem] backdrop-blur-sm">
                                    <span class="text-3xl animate-bounce">üöÄ</span>
                                    <div>
                                        <p class="text-white font-bold text-lg">Ready to start your adventure?</p>
                                        <p class="text-slate-400 text-sm">Sign in to track progress and earn certificates! <a href="/login.html" class="text-indigo-400 font-black hover:underline ml-1">Login Now</a></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Map Header -->
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-6 px-4">
                        <div class="flex items-center gap-5">
                            <div class="w-14 h-14 rounded-2xl bg-slate-900 border border-slate-800 flex items-center justify-center text-2xl shadow-xl">üåå</div>
                            <div>
                                <h3 class="text-2xl font-black text-white tracking-tight" id="map-title-display">Galactic Discovery</h3>
                                <p class="text-xs text-slate-500 font-bold uppercase tracking-[0.2em]" id="map-subtitle">Exploring the unknown</p>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="Game.render.map(null)" id="map-back-btn" class="hidden px-8 py-3 bg-slate-800 hover:bg-white hover:text-slate-950 text-white rounded-2xl text-xs font-black border border-slate-700 transition shadow-xl">‚¨Ö RETURN TO GALAXY</button>
                        </div>
                    </div>

                    <!-- Adventure Map -->
                    <div class="relative min-h-[650px] bg-slate-900/30 rounded-[4rem] border border-white/5 shadow-2xl overflow-hidden backdrop-blur-md group/map" id="map-container">
                        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-30 pointer-events-none group-hover/map:opacity-50 transition-opacity duration-1000"></div>
                        <div id="map-content" class="relative z-10 w-full h-full p-8 lg:p-16 min-h-[650px] flex flex-col items-center justify-center">
                            <!-- Planets / Levels injected here -->
                        </div>
                    </div>
                </div>

                <!-- LEADERBOARD -->
                <div id="view-leaderboard" class="view-section hidden max-w-3xl mx-auto space-y-8">
                    <div class="text-center">
                        <h1 class="text-4xl font-black text-white mb-6">Hall of Fame</h1>
                        <div class="inline-flex p-1.5 bg-slate-900 rounded-2xl border border-slate-800 shadow-xl">
                            <button onclick="Game.render.leaderboard('students')" id="lb-tab-students" class="px-6 py-2.5 rounded-xl text-sm font-black transition active-tab">Students</button>
                            <button onclick="Game.render.leaderboard('instructors')" id="lb-tab-instructors" class="px-6 py-2.5 rounded-xl text-sm font-black transition text-slate-500 hover:text-white">Instructors</button>
                        </div>
                    </div>
                    <div id="lb-list" class="bg-slate-900 rounded-[2.5rem] overflow-hidden border border-slate-800 shadow-2xl divide-y divide-slate-800"></div>
                </div>

                <!-- SHOP -->
                <div id="view-shop" class="view-section hidden max-w-6xl mx-auto space-y-10">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
                        <div class="lg:col-span-2 space-y-6">
                            <h2 class="text-3xl font-black text-white flex items-center gap-3"><span>üè™</span> Marketplace</h2>
                            <div id="shop-list" class="grid grid-cols-1 sm:grid-cols-2 gap-6"></div>
                        </div>
                        <div class="space-y-6">
                            <h2 class="text-2xl font-black text-white">üéí Inventory</h2>
                            <div id="user-inv" class="bg-slate-900 rounded-3xl p-6 border border-slate-800 min-h-[200px] flex flex-col gap-3"></div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- MOBILE OVERLAYS -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-40 hidden lg:hidden" onclick="Game.ui.toggleSidebar()"></div>

    <script>
        const Game = {
            data: { user: null, activities: [], shop: [], inventory: [], currentWorld: null },

            init: async () => {
                const uid = sessionStorage.getItem('user_id');
                const auth = sessionStorage.getItem('auth');

                console.log("üöÄ Initializing System: ID=" + uid);

                // Track Visit
                fetch('/api/visit', { method: 'POST' }).catch(() => {});

                // Set initial UI state
                if (auth === 'true' && uid) {
                    document.getElementById('auth-footer').classList.remove('hidden');
                    document.getElementById('guest-footer').classList.add('hidden');
                    document.querySelectorAll('.auth-only').forEach(el => el.classList.remove('hidden'));
                }

                // Fetch All Data
                await Game.api.loadAll(uid || "0");
                
                // Final Render
                Game.render.hud();
                Game.render.dashboard();
            },

            ui: {
                toggleSidebar: () => {
                    const side = document.getElementById('sidebar');
                    const over = document.getElementById('sidebar-overlay');
                    side.classList.toggle('-translate-x-full');
                    over.classList.toggle('hidden');
                },
                tab: (name) => {
                    document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                    const target = document.getElementById(`view-${name}`);
                    if(target) target.classList.remove('hidden');
                    
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                    const navBtn = document.getElementById(`nav-${name}`);
                    if(navBtn) navBtn.classList.add('active');
                    
                    const titles = { dashboard: 'Adventure Map', leaderboard: 'Hall of Fame', shop: 'Item Shop' };
                    document.getElementById('page-title').innerText = titles[name] || '';

                    if(window.innerWidth < 1024 && !document.getElementById('sidebar').classList.contains('-translate-x-full')) Game.ui.toggleSidebar();

                    if (name === 'leaderboard') Game.render.leaderboard();
                    if (name === 'shop') Game.render.shop();
                    if (name === 'dashboard') Game.render.map(Game.data.currentWorld);
                }
            },

            auth: {
                logout: () => { sessionStorage.clear(); location.href = '/login.html'; }
            },

            api: {
                loadAll: async (uid) => {
                    try {
                        const results = await Promise.all([
                            fetch(`/api/activities?studentId=${uid}`).then(r => r.json()),
                            fetch(`/api/analytics?userId=${uid}`).then(r => r.json())
                        ]);
                        
                        Game.data.activities = Array.isArray(results[0]) ? results[0] : [];
                        const uData = results[1];

                        if (uData && uData.user) {
                            Game.data.user = uData.user;
                            Game.data.certificates = uData.certificates || [];
                            // Force sync session for safety
                            if (Game.data.user.id) {
                                sessionStorage.setItem('user_id', Game.data.user.id);
                                sessionStorage.setItem('user_name', Game.data.user.name);
                                sessionStorage.setItem('user_role', Game.data.user.role);
                            }
                        } else {
                            Game.data.user = { name: 'Guest Explorer', level: 1, role: 'guest', avatar: 'üïµÔ∏è', coins: 0, xp: 0 };
                        }
                        
                        console.log("‚úÖ Data Sync Complete");
                    } catch (e) {
                        console.error("‚ùå Data Sync Failed", e);
                        Game.data.activities = [];
                        Game.data.user = { name: 'Offline Mode', role: 'guest', avatar: 'üì°', coins: 0, xp: 0 };
                    }
                }
            },

            render: {
                hud: () => {
                    const u = Game.data.user;
                    if (!u) return;
                    document.getElementById('hud-coins').innerText = (u.coins || 0).toLocaleString();
                    document.getElementById('hud-avatar').innerText = u.avatar || 'üôÇ';
                    
                    if (u.role === 'admin' || u.role === 'teacher') document.getElementById('menu-instructor').classList.remove('hidden');
                    if (u.role === 'admin') document.getElementById('menu-admin').classList.remove('hidden');
                    
                    if (u.role !== 'guest') {
                        document.getElementById('auth-stats').classList.remove('hidden');
                        document.getElementById('guest-msg').classList.add('hidden');
                    }
                },
                dashboard: () => {
                    const u = Game.data.user;
                    if (!u) return;
                    document.getElementById('dash-name').innerText = u.name || 'Scholar';
                    document.getElementById('dash-role').innerText = (u.role || 'guest').toUpperCase();
                    document.getElementById('dash-avatar').innerText = u.avatar || 'üôÇ';
                    document.getElementById('dash-lvl-badge').innerText = u.level || 1;
                    
                    if (u.role !== 'guest') {
                        const nextXP = (u.level || 1) * 100;
                        const pct = Math.min(((u.xp || 0) / nextXP) * 100, 100);
                        document.getElementById('dash-xp-bar').style.width = `${pct}%`;
                        document.getElementById('dash-xp-txt').innerText = `${u.xp || 0} / ${nextXP} XP`;
                        document.getElementById('dash-next-lvl').innerText = `Level ${(u.level || 1) + 1}`;
                        document.getElementById('dash-coins').innerText = (u.coins || 0).toLocaleString();
                        document.getElementById('dash-certs').innerText = (Game.data.certificates || []).length;
                    }
                    
                    Game.render.map(null);
                },
                map: (category) => {
                    const container = document.getElementById('map-content');
                    container.innerHTML = '';
                    const titleEl = document.getElementById('map-title-display');
                    const subEl = document.getElementById('map-subtitle');
                    const back = document.getElementById('map-back-btn');

                    let acts = Game.data.activities || [];
                    if (category) {
                        acts = acts.filter(a => (a.category || 'General') === category);
                        titleEl.innerText = `Sector: ${category}`;
                        subEl.innerText = `${acts.length} Destination${acts.length>1?'s':''} Found`;
                        back.classList.remove('hidden');
                    } else {
                        titleEl.innerText = `üåå Galactic Map`;
                        subEl.innerText = `Select a star system to explore`;
                        back.classList.add('hidden');
                        
                        const cats = [...new Set(acts.map(a => a.category || 'General'))];
                        if (cats.length === 0) {
                            container.innerHTML = '<div class="m-auto text-slate-600 font-bold uppercase tracking-[0.3em] animate-pulse">Initializing Galactic Data...</div>';
                            return;
                        }
                        
                        const grid = document.createElement('div');
                        grid.className = "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-12 m-auto w-full max-w-5xl";
                        cats.forEach((cat) => {
                            const count = acts.filter(a => (a.category || 'General') === cat).length;
                            const node = document.createElement('div');
                            node.className = "relative group/planet cursor-pointer transition-all duration-500 hover:-translate-y-4";
                            node.innerHTML = `
                                <div class="absolute inset-0 bg-indigo-500/20 blur-3xl opacity-0 group-hover/planet:opacity-100 transition-opacity"></div>
                                <div class="relative aspect-square bg-slate-800/50 border-4 border-slate-700 rounded-full flex flex-col items-center justify-center shadow-2xl group-hover/planet:border-indigo-500 overflow-hidden">
                                    <div class="text-7xl mb-4 group-hover/planet:scale-125 transition-transform duration-700">ü™ê</div>
                                    <div class="text-center">
                                        <div class="font-black text-white text-xs uppercase tracking-[0.2em] mb-1">${cat}</div>
                                        <div class="text-[10px] text-indigo-400 font-bold uppercase">${count} ADVENTURES</div>
                                    </div>
                                    <div class="absolute inset-0 bg-gradient-to-t from-indigo-900/40 to-transparent opacity-0 group-hover/planet:opacity-100 transition-opacity"></div>
                                </div>
                            `;
                            node.onclick = () => { Game.data.currentWorld = cat; Game.render.map(cat); };
                            grid.appendChild(node);
                        });
                        container.appendChild(grid);
                        return;
                    }

                    const path = document.createElement('div');
                    path.className = "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-10 w-full";
                    acts.forEach((act, i) => {
                        const node = document.createElement('div');
                        const isLocked = (act.price > 0 && parseInt(act.is_enrolled) === 0);
                        const isGuest = Game.data.user.role === 'guest';

                        node.className = "group/course relative bg-slate-900/80 border border-white/5 rounded-[2.5rem] p-8 hover:border-indigo-500/50 transition-all duration-500 overflow-hidden";
                        node.innerHTML = `
                            <div class="absolute -top-10 -right-10 w-32 h-32 bg-indigo-600/10 blur-3xl rounded-full group-hover/course:bg-indigo-600/20 transition-colors"></div>
                            <div class="relative z-10 flex flex-col items-center text-center gap-6">
                                <div class="w-24 h-24 rounded-3xl bg-slate-800 flex items-center justify-center text-5xl shadow-2xl group-hover/course:scale-110 transition-transform duration-500 border-2 border-white/5">
                                    ${isLocked ? 'üîí' : (act.type==='video'?'üé•':'üìú')}
                                </div>
                                <div>
                                    <h4 class="text-xl font-black text-white mb-2 leading-tight">${act.title}</h4>
                                    <div class="flex items-center justify-center gap-3">
                                        <span class="px-3 py-1 bg-white/5 rounded-full text-[10px] font-black text-slate-400 uppercase">${act.type}</span>
                                        ${act.price > 0 ? `<span class="text-yellow-400 font-black text-xs">ü™ô ${act.price}</span>` : '<span class="text-green-400 font-black text-xs uppercase">FREE</span>'}
                                    </div>
                                </div>
                                <button class="w-full py-4 rounded-2xl font-black text-xs uppercase tracking-widest transition-all ${isLocked ? 'bg-slate-800 text-slate-400' : 'bg-indigo-600 text-white hover:bg-indigo-500 shadow-lg shadow-indigo-900/20'}">
                                    ${isLocked ? 'Unlock Entry' : 'Start Mission'}
                                </button>
                            </div>
                        `;
                        
                        node.onclick = () => {
                            if (isGuest) {
                                if (confirm('Access denied. Authentication required. Relocate to login page?')) location.href = '/login.html';
                            } else {
                                location.href = `/learn.html?id=${act.id}`;
                            }
                        };
                        path.appendChild(node);
                    });
                    container.appendChild(path);
                },
                leaderboard: async (type = 'students') => {
                    const box = document.getElementById('lb-list');
                    box.innerHTML = '<div class="p-20 text-center text-slate-600 font-bold uppercase animate-pulse">Fetching Rankings...</div>';
                    try {
                        const res = await fetch('/api/leaderboard');
                        const data = await res.json();
                        const list = data[type] || [];
                        box.innerHTML = list.map((u, i) => `
                            <div class="flex items-center gap-4 p-6 hover:bg-slate-800/40 transition">
                                <div class="w-10 text-xl font-black ${i<3?'text-yellow-500':'text-slate-600'}">#${i+1}</div>
                                <div class="w-12 h-12 rounded-2xl bg-slate-800 border border-slate-700 flex items-center justify-center text-2xl">${u.avatar||'üë§'}</div>
                                <div class="flex-1 min-w-0"><div class="font-bold text-white truncate text-lg">${u.name}</div><div class="text-[10px] text-indigo-400 font-black uppercase tracking-widest">${u.role}</div></div>
                                <div class="text-right"><div class="text-yellow-400 font-black text-xl">${(type==='students'?(u.xp||0):(u.avg_rating||0)).toLocaleString()}</div><div class="text-[10px] text-slate-500 font-bold uppercase">${type==='students'?'XP':'Rating'}</div></div>
                            </div>`).join('') || '<div class="p-10 text-center text-slate-600">No data found</div>';
                    } catch(e) { box.innerHTML = '<div class="p-10 text-center text-red-500">Failed to load rankings</div>'; }
                },
                shop: async () => {
                    const shopEl = document.getElementById('shop-list');
                    const invEl = document.getElementById('user-inv');
                    if (Game.data.user.role === 'guest') {
                        shopEl.innerHTML = '<div class="col-span-full p-20 glass rounded-[2.5rem] text-center"><h3 class="text-xl font-bold text-white mb-2 text-yellow-500">Locked üîí</h3><p class="text-slate-400">Please login to access the marketplace.</p></div>';
                        invEl.innerHTML = '<div class="text-center py-10 text-slate-600 uppercase text-[10px] font-black">Login to use Backpack</div>';
                        return;
                    }
                    try {
                        const [sRes, iRes] = await Promise.all([fetch('/api/shop'), fetch(`/api/inventory?userId=${sessionStorage.getItem('user_id')}`)]);
                        const items = await sRes.json();
                        const inventory = await iRes.json();
                        shopEl.innerHTML = items.map(item => `<div class="glass p-8 rounded-[2.5rem] border border-slate-800 flex flex-col items-center text-center gap-2 group hover:border-indigo-500 transition shadow-2xl relative overflow-hidden"><div class="text-6xl mb-4 group-hover:scale-110 transition duration-300">${item.icon}</div><h4 class="font-black text-white text-lg">${item.name}</h4><button onclick="Game.api.buy(${item.id})" class="mt-4 w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-black rounded-2xl transition shadow-xl">ü™ô ${item.price}</button></div>`).join('');
                        invEl.innerHTML = inventory.map(i => `<div class="flex items-center gap-3 p-3 bg-slate-800/50 rounded-2xl border border-slate-700"><span class="text-2xl">${i.icon}</span><span class="text-sm font-bold text-white truncate">${i.name}</span></div>`).join('') || '<div class="text-center py-10 text-slate-600 font-bold uppercase text-xs">Empty Backpack</div>';
                    } catch(e) {}
                }
            },
            api: {
                buy: async (id) => {
                    if(!confirm('Purchase item?')) return;
                    try {
                        const res = await fetch('/api/shop/buy', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ userId: sessionStorage.getItem('user_id'), itemId: id }) });
                        const d = await res.json();
                        if(d.success) { alert('Purchased! üéÅ'); Game.init(); } else { alert(d.error || 'Failed'); }
                    } catch(e) {}
                }
            }
        };

        document.addEventListener('DOMContentLoaded', Game.init);
    </script>
</body>
</html>