<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdaptLearn Adventure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #0f172a; color: #e2e8f0; overflow-x: hidden; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .nav-item.active { background-color: #1e293b; color: white; border-left: 4px solid #ef4444; }
        .animate-float { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>

<body class="bg-slate-950">

    <!-- GUEST / LOGIN SCREEN -->
    <div id="guest-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-950 hidden">
        <div class="text-center p-10 max-w-md w-full glass rounded-[2.5rem] border border-slate-800 shadow-2xl animate-fade-in mx-4">
            <div class="text-7xl mb-6 animate-float">üõ°Ô∏è</div>
            <h1 class="text-3xl font-black text-white mb-2">AdaptLearn Pro</h1>
            <p class="text-slate-500 mb-8">Begin your learning adventure today.</p>
            <a href="/login.html" class="block w-full py-4 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-2xl shadow-lg transition transform hover:scale-105 active:scale-95 mb-4">
                Enter Adventure
            </a>
            <div class="text-[10px] text-slate-600 uppercase tracking-widest font-bold">
                System Online ‚Ä¢ <span id="visitor-count">...</span>
            </div>
        </div>
    </div>

    <!-- APP LAYOUT -->
    <div id="app-layout" class="flex h-screen overflow-hidden hidden">
        
        <!-- SIDEBAR (Responsive) -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-slate-900 border-r border-slate-800 flex flex-col z-50 transform -translate-x-full lg:translate-x-0 lg:static transition-transform duration-300 ease-in-out">
            <div class="h-20 flex items-center px-6 border-b border-slate-800">
                <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white text-xl shadow-lg mr-3">üß†</div>
                <span class="font-black text-white text-lg tracking-tight">AdaptLearn</span>
            </div>

            <nav class="flex-1 p-4 space-y-1 overflow-y-auto custom-scrollbar">
                <button onclick="Game.ui.tab('dashboard')" class="w-full text-left px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 transition flex items-center gap-3 nav-item active" id="nav-dashboard">
                    <i class="fa-solid fa-map"></i><span class="font-bold text-sm">Adventure Map</span>
                </button>
                <button onclick="Game.ui.tab('leaderboard')" class="w-full text-left px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 transition flex items-center gap-3 nav-item" id="nav-leaderboard">
                    <i class="fa-solid fa-trophy"></i><span class="font-bold text-sm">Hall of Fame</span>
                </button>
                <button onclick="Game.ui.tab('shop')" class="w-full text-left px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 transition flex items-center gap-3 nav-item" id="nav-shop">
                    <i class="fa-solid fa-store"></i><span class="font-bold text-sm">Item Shop</span>
                </button>
                <div class="border-t border-slate-800 my-4"></div>
                <a href="/profile.html" class="w-full text-left px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 transition flex items-center gap-3">
                    <i class="fa-solid fa-user-astronaut"></i><span class="font-bold text-sm">My Profile</span>
                </a>
                
                <!-- Special Menus -->
                <a href="/instructor.html" id="menu-instructor" class="hidden w-full text-left px-4 py-3 rounded-xl text-yellow-500 hover:bg-yellow-500/10 transition flex items-center gap-3">
                    <i class="fa-solid fa-wand-magic-sparkles"></i><span class="font-bold text-sm">Instructor Studio</span>
                </a>
                <a href="/admin.html" id="menu-admin" class="hidden w-full text-left px-4 py-3 rounded-xl text-red-500 hover:bg-red-500/10 transition flex items-center gap-3">
                    <i class="fa-solid fa-shield-halved"></i><span class="font-bold text-sm">Admin Panel</span>
                </a>
            </nav>

            <div class="p-4 border-t border-slate-800">
                <button onclick="Game.auth.logout()" class="w-full py-3 text-red-400 font-bold flex items-center justify-center gap-2 hover:bg-red-500/10 rounded-xl transition">
                    <i class="fa-solid fa-right-from-bracket"></i><span>Logout</span>
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col min-w-0 bg-slate-950 overflow-hidden">
            
            <!-- TOP NAVBAR -->
            <header class="h-16 lg:h-20 glass flex items-center justify-between px-4 lg:px-8 z-40 flex-shrink-0">
                <div class="flex items-center gap-4">
                    <button onclick="Game.ui.toggleSidebar()" class="lg:hidden w-10 h-10 flex items-center justify-center text-slate-400 text-xl"><i class="fa-solid fa-bars"></i></button>
                    <h2 class="text-xl lg:text-2xl font-black text-white truncate" id="page-title">World Map</h2>
                </div>
                
                <div class="flex items-center gap-2 lg:gap-6">
                    <div class="flex items-center gap-2 bg-slate-900/80 px-3 lg:px-4 py-1.5 lg:py-2 rounded-2xl border border-slate-800 shadow-lg">
                        <span class="text-lg lg:text-xl">ü™ô</span>
                        <span class="font-black text-yellow-400 text-sm lg:text-base" id="hud-coins">0</span>
                    </div>
                    <div class="hidden sm:flex items-center gap-2 bg-slate-900/80 px-4 py-2 rounded-2xl border border-slate-800 shadow-lg">
                        <span class="text-xl">üî•</span>
                        <span class="font-black text-orange-500" id="hud-streak">0</span>
                    </div>
                    <div class="w-10 h-10 lg:w-12 lg:h-12 rounded-2xl bg-slate-800 flex items-center justify-center text-xl lg:text-2xl border border-slate-700 shadow-xl cursor-pointer" onclick="location.href='/profile.html'" id="hud-avatar">üôÇ</div>
                </div>
            </header>

            <!-- CONTENT AREA -->
            <div class="flex-1 overflow-y-auto p-4 lg:p-10 custom-scrollbar relative" id="content-scroll">
                
                <!-- DASHBOARD -->
                <div id="view-dashboard" class="view-section space-y-8 max-w-7xl mx-auto">
                    <!-- Welcome Hero -->
                    <div class="relative p-6 lg:p-10 rounded-[2.5rem] bg-gradient-to-br from-indigo-900/40 to-slate-900 border border-indigo-500/20 shadow-2xl overflow-hidden">
                        <div class="absolute -top-24 -right-24 w-64 h-64 bg-indigo-600/20 blur-[100px] rounded-full"></div>
                        <div class="relative z-10 flex flex-col md:flex-row items-center gap-6 lg:gap-10">
                            <div class="w-24 h-24 lg:w-32 lg:h-32 rounded-[2rem] bg-slate-800 flex items-center justify-center text-5xl lg:text-6xl border-4 border-indigo-500 shadow-2xl" id="dash-avatar">üôÇ</div>
                            <div class="flex-1 text-center md:text-left">
                                <h3 class="text-xs font-bold text-indigo-400 uppercase tracking-widest mb-1" id="dash-role">Student</h3>
                                <h2 class="text-3xl lg:text-4xl font-black text-white mb-4">Hi, <span id="dash-name" class="text-indigo-300">Hero</span>!</h2>
                                <div class="max-w-md mx-auto md:mx-0">
                                    <div class="flex justify-between text-[10px] font-black text-slate-500 uppercase mb-2">
                                        <span>Level <span id="dash-lvl" class="text-white">1</span></span>
                                        <span id="dash-xp-txt">0 / 100 XP</span>
                                    </div>
                                    <div class="h-2.5 bg-slate-800 rounded-full overflow-hidden p-0.5 border border-slate-700">
                                        <div id="dash-xp-bar" class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 rounded-full w-0 transition-all duration-1000"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Adventure Map -->
                    <div class="relative min-h-[600px] bg-slate-900/50 rounded-[3rem] border border-slate-800 shadow-inner overflow-hidden" id="map-container">
                        <div class="absolute top-6 left-6 z-20 flex gap-2">
                            <span class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-black uppercase tracking-wider shadow-lg border border-indigo-400" id="map-label">üåå Galactic Map</span>
                            <button onclick="Game.render.map(null)" class="hidden bg-slate-800 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-slate-700 border border-slate-600" id="map-back-btn">‚¨Ö Back</button>
                        </div>
                        <div id="map-content" class="relative z-10 w-full h-full p-10 min-h-[600px]"></div>
                    </div>
                </div>

                <!-- LEADERBOARD -->
                <div id="view-leaderboard" class="view-section hidden max-w-3xl mx-auto space-y-8">
                    <div class="text-center">
                        <h1 class="text-4xl font-black text-white mb-6">Hall of Fame</h1>
                        <div class="inline-flex p-1.5 bg-slate-900 rounded-2xl border border-slate-800 shadow-xl">
                            <button onclick="Game.render.leaderboard('students')" id="lb-tab-students" class="px-6 py-2.5 rounded-xl text-sm font-black transition active-tab">Students</button>
                            <button onclick="Game.render.leaderboard('instructors')" id="lb-tab-instructors" class="px-6 py-2.5 rounded-xl text-sm font-black transition text-slate-500 hover:text-white">Instructors</button>
                        </div>
                    </div>
                    <div id="lb-list" class="bg-slate-900 rounded-[2.5rem] overflow-hidden border border-slate-800 shadow-2xl divide-y divide-slate-800"></div>
                </div>

                <!-- SHOP -->
                <div id="view-shop" class="view-section hidden max-w-6xl mx-auto space-y-10">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
                        <div class="lg:col-span-2 space-y-6">
                            <h2 class="text-3xl font-black text-white flex items-center gap-3"><span>üè™</span> Marketplace</h2>
                            <div id="shop-list" class="grid grid-cols-1 sm:grid-cols-2 gap-6"></div>
                        </div>
                        <div class="space-y-6">
                            <h2 class="text-2xl font-black text-white">üéí Inventory</h2>
                            <div id="user-inv" class="bg-slate-900 rounded-3xl p-6 border border-slate-800 min-h-[200px] flex flex-col gap-3"></div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- OVERLAY FOR MOBILE SIDEBAR -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-40 hidden lg:hidden" onclick="Game.ui.toggleSidebar()"></div>

    <script>
        const Game = {
            data: { user: null, activities: [], shop: [], inventory: [], currentWorld: null },

            init: async () => {
                const uid = sessionStorage.getItem('user_id');
                if (!uid) { 
                    document.getElementById('guest-screen').classList.remove('hidden');
                    try {
                        const res = await fetch('/api/visit');
                        const data = await res.json();
                        document.getElementById('visitor-count').innerText = `Visitors: ${data.total_visits || 0}`;
                    } catch(e) {}
                    return; 
                }

                document.getElementById('app-layout').classList.remove('hidden');
                await Game.api.loadAll(uid);
                
                Game.render.hud();
                Game.render.dashboard();
            },

            ui: {
                toggleSidebar: () => {
                    const side = document.getElementById('sidebar');
                    const over = document.getElementById('sidebar-overlay');
                    side.classList.toggle('-translate-x-full');
                    over.classList.toggle('hidden');
                },
                tab: (name) => {
                    document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                    document.getElementById(`view-${name}`).classList.remove('hidden');
                    
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active-tab'));
                    document.getElementById(`nav-${name}`).classList.add('active-tab');
                    
                    const titles = { dashboard: 'Adventure Map', leaderboard: 'Hall of Fame', shop: 'Item Shop' };
                    document.getElementById('page-title').innerText = titles[name] || '';

                    if(window.innerWidth < 1024) Game.ui.toggleSidebar(); // Close sidebar on mobile select

                    if (name === 'leaderboard') Game.render.leaderboard();
                    if (name === 'shop') Game.render.shop();
                    if (name === 'dashboard') Game.render.map(Game.data.currentWorld);
                }
            },

            auth: {
                logout: () => { sessionStorage.clear(); location.href = '/login.html'; }
            },

            api: {
                loadAll: async (uid) => {
                    try {
                        // Pass studentId to activities to check enrollment status
                        const [uRes, aRes] = await Promise.all([
                            fetch(`/api/analytics?userId=${uid}`),
                            fetch(`/api/activities?studentId=${uid}`)
                        ]);
                        const uData = await uRes.json();
                        const aData = await aRes.json();

                        Game.data.user = uData.user || { name: 'Unknown Hero', level: 1, coins: 0, streak: 0, role: 'student', avatar: 'üôÇ' };
                        Game.data.activities = Array.isArray(aData) ? aData : [];
                        
                        // Save name to session for certs
                        if(Game.data.user.name) sessionStorage.setItem('user_name', Game.data.user.name);
                        
                        console.log("Real DB Data Loaded:", Game.data.user);
                    } catch (e) {
                        console.error("Critical Fetch Error", e);
                        Game.data.user = { name: 'Offline Mode', level: 1, role: 'student', avatar: 'üïµÔ∏è' };
                    }
                }
            },

            render: {
                hud: () => {
                    const u = Game.data.user;
                    document.getElementById('hud-coins').innerText = (u.coins || 0).toLocaleString();
                    document.getElementById('hud-streak').innerText = u.streak || 0;
                    document.getElementById('hud-avatar').innerText = u.avatar || 'üôÇ';

                    if (u.role === 'admin' || u.role === 'teacher') document.getElementById('menu-instructor').classList.remove('hidden');
                    if (u.role === 'admin') document.getElementById('menu-admin').classList.remove('hidden');
                },
                dashboard: () => {
                    const u = Game.data.user;
                    document.getElementById('dash-name').innerText = u.name;
                    document.getElementById('dash-role').innerText = (u.role || 'student').toUpperCase();
                    document.getElementById('dash-lvl').innerText = u.level || 1;
                    document.getElementById('dash-avatar').innerText = u.avatar || 'üôÇ';
                    
                    const nextXP = (u.level || 1) * 100;
                    const pct = Math.min(((u.xp || 0) / nextXP) * 100, 100);
                    document.getElementById('dash-xp-bar').style.width = `${pct}%`;
                    document.getElementById('dash-xp-txt').innerText = `${u.xp || 0} / ${nextXP} XP`;
                    
                    Game.render.map(null);
                },
                map: (category) => {
                    const container = document.getElementById('map-content');
                    container.innerHTML = '';
                    const label = document.getElementById('map-label');
                    const back = document.getElementById('map-back-btn');

                    let acts = Game.data.activities;
                    if (category) {
                        acts = acts.filter(a => (a.category || 'General') === category);
                        label.innerText = `World: ${category}`;
                        back.classList.remove('hidden');
                    } else {
                        label.innerText = `üåå Galactic Map`;
                        back.classList.add('hidden');
                        
                        const cats = [...new Set(acts.map(a => a.category || 'General'))];
                        cats.forEach((cat, i) => {
                            const node = document.createElement('div');
                            node.className = "lg:absolute w-40 h-40 bg-slate-800 border-4 border-slate-700 rounded-full flex flex-col items-center justify-center cursor-pointer hover:scale-110 hover:border-indigo-500 transition shadow-2xl z-20 mx-auto my-4 lg:my-0";
                            node.style.left = window.innerWidth > 1024 ? `${20 + (i % 3) * 30}%` : 'auto';
                            node.style.top = window.innerWidth > 1024 ? `${10 + Math.floor(i / 3) * 40}%` : 'auto';
                            node.innerHTML = `<div class="text-5xl mb-2">ü™ê</div><div class="font-black text-white text-xs uppercase tracking-tighter">${cat}</div>`;
                            node.onclick = () => { Game.data.currentWorld = cat; Game.render.map(cat); };
                            container.appendChild(node);
                        });
                        return;
                    }

                    acts.forEach((act, i) => {
                        const node = document.createElement('div');
                        node.className = "lg:absolute w-24 h-24 bg-slate-800 border-4 border-indigo-500 rounded-3xl flex flex-col items-center justify-center text-3xl shadow-2xl hover:scale-110 transition cursor-pointer z-10 mx-auto my-6 lg:my-0 relative";
                        node.style.left = window.innerWidth > 1024 ? `${25 + (i % 2 === 0 ? 0 : 40)}%` : 'auto';
                        node.style.top = window.innerWidth > 1024 ? `${50 + (i * 150)}px` : 'auto';
                        
                        const isLocked = (act.price > 0 && act.is_enrolled == 0);
                        node.innerHTML = `<span>${isLocked ? 'üîí' : (act.type==='video'?'üìú':'üéÆ')}</span>`;
                        node.onclick = () => location.href = `/learn.html?id=${act.id}`;
                        
                        const title = document.createElement('div');
                        title.className = "absolute -bottom-10 left-1/2 -translate-x-1/2 bg-slate-900 px-3 py-1 rounded-lg border border-slate-700 text-[10px] font-bold text-white whitespace-nowrap z-30 shadow-xl";
                        title.innerText = act.title + (isLocked ? ` (ü™ô${act.price})` : '');
                        node.appendChild(title);
                        container.appendChild(node);
                    });
                    
                    if(window.innerWidth > 1024) container.style.height = `${acts.length * 150 + 300}px`;
                    else container.style.height = 'auto';
                },
                leaderboard: async (type = 'students') => {
                    const box = document.getElementById('lb-list');
                    const tabS = document.getElementById('lb-tab-students');
                    const tabI = document.getElementById('lb-tab-instructors');
                    
                    tabS.className = `px-6 py-2.5 rounded-xl text-sm font-black transition ${type==='students'?'active-tab shadow-lg':'text-slate-500'}`;
                    tabI.className = `px-6 py-2.5 rounded-xl text-sm font-black transition ${type==='instructors'?'active-tab shadow-lg':'text-slate-500'}`;
                    
                    box.innerHTML = '<div class="p-20 text-center text-slate-600 font-bold uppercase tracking-widest animate-pulse">Loading Rankings...</div>';
                    
                    try {
                        const res = await fetch('/api/leaderboard');
                        const data = await res.json();
                        const list = data[type] || [];

                        box.innerHTML = list.map((u, i) => `
                            <div class="flex items-center gap-4 p-6 hover:bg-slate-800/40 transition">
                                <div class="w-10 text-xl font-black ${i<3?'text-yellow-500':'text-slate-600'}">#${i+1}</div>
                                <div class="w-12 h-12 rounded-2xl bg-slate-800 border border-slate-700 flex items-center justify-center text-2xl">${u.avatar||'üë§'}</div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-bold text-white truncate text-lg">${u.name}</div>
                                    <div class="text-[10px] text-indigo-400 font-black uppercase tracking-widest">${u.role}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-yellow-400 font-black text-xl">${(type==='students'?(u.xp||0):(u.avg_rating||0)).toLocaleString()}</div>
                                    <div class="text-[10px] text-slate-500 font-bold uppercase">${type==='students'?'XP':'Rating'}</div>
                                </div>
                            </div>
                        `).join('') || '<div class="p-10 text-center text-slate-600">No data found</div>';
                    } catch(e) { box.innerHTML = '<div class="p-10 text-center text-red-500">Failed to load rankings</div>'; }
                },
                shop: async () => {
                    const shopEl = document.getElementById('shop-list');
                    const invEl = document.getElementById('user-inv');
                    
                    try {
                        const [sRes, iRes] = await Promise.all([
                            fetch('/api/shop'),
                            fetch(`/api/inventory?userId=${sessionStorage.getItem('user_id')}`)
                        ]);
                        const items = await sRes.json();
                        const inventory = await iRes.json();

                        shopEl.innerHTML = items.map(item => `
                            <div class="glass p-6 rounded-[2rem] border border-slate-800 flex flex-col items-center text-center gap-2 group hover:border-indigo-500 transition shadow-2xl relative overflow-hidden">
                                <div class="text-6xl mb-4 group-hover:scale-110 transition duration-300">${item.icon}</div>
                                <h4 class="font-black text-white text-lg">${item.name}</h4>
                                <p class="text-xs text-slate-500 h-10 overflow-hidden">${item.description || ''}</p>
                                <button onclick="Game.api.buy(${item.id})" class="mt-4 w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-black rounded-2xl shadow-xl active:scale-95 transition">
                                    ü™ô ${item.price.toLocaleString()}
                                </button>
                            </div>
                        `).join('');

                        invEl.innerHTML = inventory.map(i => `
                            <div class="flex items-center gap-3 p-3 bg-slate-800/50 rounded-2xl border border-slate-700">
                                <span class="text-2xl">${i.icon}</span>
                                <span class="text-sm font-bold text-white truncate">${i.name}</span>
                            </div>
                        `).join('') || '<div class="text-center py-10 text-slate-600 font-bold uppercase text-xs">Empty Backpack</div>';
                    } catch(e) {}
                }
            },
            api: {
                buy: async (id) => {
                    if(!confirm('Purchase item?')) return;
                    try {
                        const res = await fetch('/api/shop/buy', { 
                            method: 'POST', 
                            headers: {'Content-Type':'application/json'},
                            body: JSON.stringify({ userId: sessionStorage.getItem('user_id'), itemId: id }) 
                        });
                        const d = await res.json();
                        if(d.success) { 
                            alert('Purchased! üéÅ'); 
                            Game.init(); // Refresh data
                        } else { alert(d.error || 'Insufficient coins'); }
                    } catch(e) { alert('Transaction Failed'); }
                }
            }
        };

        document.addEventListener('DOMContentLoaded', Game.init);
    </script>
</body>
</html>