<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdaptLearn Adventure - The Knowledge Quest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&amp;display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #1a1a2e; color: #e2e8f0; } /* Dark Theme Base */
        .btn-game { 
            background: linear-gradient(to bottom, #f59e0b, #d97706); border: 2px solid #78350f; 
            box-shadow: 0 4px 0 #78350f; color: white; text-shadow: 1px 1px 0 #78350f;
            transition: all 0.1s;
        }
        .btn-game:active { transform: translateY(4px); box-shadow: 0 0 0 #78350f; }
        .glass-panel { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(8px); border: 2px solid rgba(255,255,255,0.1); border-radius: 1rem; }
        .map-path { stroke: #6366f1; stroke-width: 4; stroke-dasharray: 10; animation: dash 20s linear infinite; }
        @keyframes dash { to { stroke-dashoffset: 1000; } }
        @keyframes bob { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .avatar-bob { animation: bob 3s ease-in-out infinite; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        .animate-zoom-in { animation: zoomIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        /* Mobile Fixes */
        @media (max-width: 640px) {
            #hudPlayer, #hudResources { display: none !important; } /* Hide complex HUD on mobile */
            #hudMobileMenu { display: block !important; }
        }
    </style>
</head>

<body class="bg-slate-900 min-h-screen bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] overflow-x-hidden">
    
    <!-- Top Bar (Game HUD) -->
    <header class="fixed top-0 w-full z-50 p-2 sm:p-4 pointer-events-none">
        <div class="max-w-7xl mx-auto flex justify-between items-center pointer-events-auto bg-slate-900/80 backdrop-blur-md rounded-2xl p-2 border border-slate-700 shadow-xl">
            
            <!-- Logo -->
            <div class="cursor-pointer group flex items-center gap-2 pl-2" onclick="location.reload()">
                <span class="text-2xl">ğŸ›¡ï¸</span>
                <h1 class="text-lg sm:text-2xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 drop-shadow-sm hidden sm:block">AdaptLearn</h1>
            </div>

            <!-- PC HUD -->
            <div class="hidden sm:flex gap-3 items-center" id="hudPC">
                <div class="flex items-center gap-2 bg-slate-800 px-3 py-1 rounded-full border border-yellow-600/50">
                    <span class="text-lg">ğŸª™</span> <span class="font-bold text-yellow-400 font-mono" id="hudCoins">0</span>
                </div>
                <div class="flex items-center gap-2 bg-slate-800 px-3 py-1 rounded-full border border-orange-600/50">
                    <span class="text-lg">ğŸ”¥</span> <span class="font-bold text-orange-400 font-mono" id="hudStreak">0</span>
                </div>
                <div class="h-8 w-[1px] bg-slate-600 mx-2"></div>
                <div class="flex items-center gap-3 cursor-pointer hover:bg-slate-800 p-1 rounded-lg transition" onclick="window.location.href='/profile.html'">
                    <div class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center text-sm border border-white" id="hudAvatar">ğŸ™‚</div>
                    <div class="text-sm font-bold text-white max-w-[100px] truncate" id="hudName">Player</div>
                </div>
            </div>

            <!-- Mobile Login / Menu -->
            <div id="hudGuest" class="hidden">
                <a href="/login.html" class="btn-game px-4 py-2 rounded-lg font-bold text-sm whitespace-nowrap">Login</a>
            </div>
            
            <!-- Mobile Menu Toggle (Logged In) -->
            <button id="mobileMenuBtn" class="hidden sm:hidden text-white text-2xl p-2" onclick="AdaptLearnPro.ui.toggleMobileMenu()">â˜°</button>
        </div>
    </header>

    <!-- Side Buttons (Desktop) -->
    <div class="fixed left-6 top-32 z-40 hidden sm:flex flex-col gap-4">
        <button onclick="AdaptLearnPro.leaderboard.open()" class="w-14 h-14 bg-yellow-500 hover:bg-yellow-400 text-slate-900 rounded-full shadow-xl border-4 border-yellow-700 flex items-center justify-center text-3xl transition transform hover:scale-110 active:scale-95" title="Leaderboard">ğŸ†</button>
    <!-- Shop Button (Left Side Fixed - Below Leaderboard) -->
    <button onclick="AdaptLearnPro.shop.open()" class="fixed left-6 top-44 w-14 h-14 bg-blue-600 hover:bg-blue-500 text-white rounded-full shadow-xl border-4 border-blue-800 flex items-center justify-center text-3xl z-40 transition transform hover:scale-110 active:scale-95" title="Item Shop">
        ğŸ›’
    </button>

    <!-- Logout Button (Left Side Fixed - Below Shop) -->
    <button onclick="AdaptLearnPro.auth.logout()" class="fixed left-6 top-64 w-14 h-14 bg-red-600 hover:bg-red-500 text-white rounded-full shadow-xl border-4 border-red-800 flex items-center justify-center text-3xl z-40 transition transform hover:scale-110 active:scale-95" title="Logout">
        ğŸšª
    </button>
    </div>

    <!-- Mobile Menu Overlay -->
    <div id="mobileMenu" class="fixed inset-0 bg-slate-900/95 z-[60] hidden flex-col items-center justify-center space-y-6 animate-zoom-in">
        <button onclick="AdaptLearnPro.ui.toggleMobileMenu()" class="absolute top-4 right-4 text-white text-4xl">âœ•</button>
        <div class="text-center mb-4">
            <div class="w-20 h-20 bg-indigo-600 rounded-full flex items-center justify-center text-4xl border-4 border-white mx-auto mb-2" id="mobAvatar">ğŸ™‚</div>
            <div class="text-xl font-bold text-white" id="mobName">Player</div>
        </div>
        <button onclick="AdaptLearnPro.leaderboard.open(); AdaptLearnPro.ui.toggleMobileMenu()" class="text-2xl font-bold text-yellow-400 flex items-center gap-2">ğŸ† Leaderboard</button>
        <button onclick="AdaptLearnPro.shop.open(); AdaptLearnPro.ui.toggleMobileMenu()" class="text-2xl font-bold text-blue-400 flex items-center gap-2">ğŸ›’ Item Shop</button>
        <a href="/profile.html" class="text-2xl font-bold text-white">ğŸ‘¤ Profile</a>
        <a href="/admin.html" id="mobLinkAdmin" class="hidden text-xl font-bold text-slate-400">ğŸ› ï¸ Instructor</a>
        <button onclick="AdaptLearnPro.auth.logout()" class="text-xl font-bold text-red-500 mt-8">ğŸšª Logout</button>
    </div>

    <div class="pt-24 pb-12 px-4 max-w-7xl mx-auto min-h-screen">
        
        <!-- DASHBOARD (LOBBY) -->
        <div id="dashboard-content" class="tab-content hidden animate-zoom-in">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                
                <!-- Main Character Showcase -->
                <div class="lg:col-span-5 flex flex-col items-center justify-center min-h-[40vh] relative">
                    <div class="absolute inset-0 bg-indigo-500/10 blur-[100px] rounded-full"></div>
                    
                    <!-- Avatar -->
                    <div class="relative avatar-bob group cursor-pointer" onclick="location.href='/profile.html'">
                        <div class="w-48 h-48 sm:w-64 sm:h-64 bg-gradient-to-b from-slate-700 to-slate-800 rounded-3xl border-4 border-slate-600 shadow-2xl flex items-center justify-center text-[6rem] sm:text-[10rem] relative z-10 group-hover:border-indigo-400 transition transform group-hover:scale-105">
                            <span id="lobbyAvatar">ğŸ™‚</span>
                        </div>
                        <div class="absolute -bottom-6 left-1/2 -translate-x-1/2 bg-slate-900 px-6 py-2 rounded-xl border border-slate-600 whitespace-nowrap z-20 shadow-lg">
                            <span class="text-slate-400 text-xs uppercase font-bold tracking-widest block text-center mb-1">Class</span>
                            <span class="text-indigo-400 font-bold text-lg" id="lobbyRole">Novice</span>
                        </div>
                    </div>

                    <!-- Daily Quest Board -->
                    <div class="mt-16 w-full max-w-md glass-panel p-6 transform -rotate-1 hover:rotate-0 transition duration-300 relative mx-4">
                        <div class="absolute -top-3 -right-3 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-lg animate-bounce">NEW!</div>
                        <h3 class="text-yellow-400 font-bold text-lg mb-4 flex items-center gap-2">ğŸ“œ Daily Quests</h3>
                        <div class="space-y-3">
                            <div class="bg-slate-800/50 p-3 rounded-lg flex items-center justify-between border border-slate-700 hover:bg-slate-700/50 transition">
                                <div class="flex items-center gap-3">
                                    <div class="w-6 h-6 rounded-full border border-green-500 bg-green-500/20 text-green-500 flex items-center justify-center text-xs shadow-[0_0_10px_rgba(34,197,94,0.4)]">âœ“</div>
                                    <span class="text-sm text-slate-300 font-medium">Daily Login</span>
                                </div>
                                <span class="text-xs font-bold text-yellow-500 bg-yellow-900/30 px-2 py-1 rounded border border-yellow-700">+10 ğŸª™</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Adventure Map -->
                <div class="lg:col-span-7 relative">
                    <h2 class="text-2xl sm:text-3xl font-black text-white mb-6 drop-shadow-md flex flex-wrap items-center gap-3 px-4">
                        <span>ğŸ—ºï¸</span> Map <span id="mapTitleBadge" class="text-sm font-normal text-slate-400 bg-slate-800 px-3 py-1 rounded-lg border border-slate-700">Zone Selection</span>
                    </h2>
                    
                    <div class="relative min-h-[500px] sm:min-h-[600px] bg-slate-800/50 rounded-3xl border-4 border-slate-700 p-4 sm:p-8 shadow-inner overflow-hidden custom-scrollbar mx-2 sm:mx-0" id="mapContainer">
                        <svg class="absolute inset-0 w-full h-full pointer-events-none z-0" id="mapLines"></svg>
                        <div id="mapNodes" class="relative z-10 h-full w-full"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI TUTOR (Floating) -->
        <div id="ai-tutor-content" class="tab-content hidden animate-zoom-in fixed bottom-24 right-4 sm:right-8 z-50">
             <div class="w-80 sm:w-96 bg-slate-800 rounded-2xl shadow-2xl border border-slate-700 h-[500px] flex flex-col overflow-hidden">
                <div class="p-4 bg-slate-900 border-b border-slate-700 flex justify-between items-center">
                    <h2 class="font-bold text-indigo-400 flex items-center gap-2 text-lg">ğŸ¤– AI Game Master</h2>
                    <button onclick="AdaptLearnPro.ui.toggleAI()" class="text-slate-400 hover:text-white transition bg-slate-700 rounded-full w-8 h-8 flex items-center justify-center">âœ•</button>
                </div>
                <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-800/50 scroll-smooth">
                    <div class="flex items-start gap-3">
                        <div class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center text-white text-xs shadow-lg border border-indigo-400">ğŸ¤–</div>
                        <div class="bg-slate-700 p-3 rounded-2xl rounded-tl-none shadow-sm border border-slate-600 text-slate-200 text-xs">
                            Greetings! Need a hint?
                        </div>
                    </div>
                </div>
                <div class="p-3 bg-slate-900 border-t border-slate-700 flex gap-2 relative z-10">
                    <input id="chatInput" type="text" class="flex-1 bg-slate-800 text-white border border-slate-600 rounded-xl px-3 py-2 text-sm outline-none focus:border-indigo-500" placeholder="Type here...">
                    <button onclick="AdaptLearnPro.ai.send()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-xl font-bold text-sm shadow-lg">Send</button>
                </div>
             </div>
        </div>

    </div>

    <!-- Floating Action Button for AI -->
    <button id="aiFloatingBtn" onclick="AdaptLearnPro.ui.toggleAI()" class="fixed bottom-6 right-4 sm:bottom-8 sm:right-8 w-14 h-14 sm:w-16 sm:h-16 bg-indigo-600 hover:bg-indigo-500 text-white rounded-full shadow-2xl flex items-center justify-center text-3xl z-40 border-4 border-slate-800 hover:scale-110 transition animate-bounce hidden" title="Open AI Chat">
        ğŸ¤–
    </button>

    <!-- Modals (Shop/Leaderboard) -->
    <!-- Shop Modal -->
    <div id="shopModal" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 w-full max-w-4xl h-[85vh] rounded-3xl shadow-2xl flex flex-col overflow-hidden animate-zoom-in border-4 border-blue-600">
            <div class="bg-blue-900 p-4 flex justify-between items-center shadow-lg">
                <h2 class="text-2xl font-black text-white">ğŸª Item Shop</h2>
                <button onclick="document.getElementById('shopModal').classList.add('hidden')" class="text-white text-2xl">âœ•</button>
            </div>
            <div class="flex-1 flex flex-col sm:flex-row overflow-hidden">
                <div class="flex-1 p-4 overflow-y-auto bg-slate-900" id="shop-list"></div>
                <div class="sm:w-72 p-4 bg-slate-800 border-l border-slate-700 overflow-y-auto" id="inventory-list">
                    <h3 class="font-bold text-white mb-4">ğŸ’ Inventory</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaderboard Modal -->
    <div id="leaderboardModal" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 w-full max-w-md h-[80vh] rounded-3xl shadow-2xl flex flex-col overflow-hidden animate-zoom-in border-4 border-yellow-600">
            <div class="bg-yellow-700 p-4 flex justify-between items-center shadow-lg">
                <h2 class="text-2xl font-black text-white">ğŸ† Leaderboard</h2>
                <button onclick="document.getElementById('leaderboardModal').classList.add('hidden')" class="text-white text-2xl">âœ•</button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-2" id="lb-list"></div>
            <div class="bg-slate-800 p-4 flex items-center gap-4 border-t border-slate-700">
                <div class="font-bold text-slate-500 w-6 text-center" id="lb-self-rank">-</div>
                <div class="flex-1 text-white font-bold" id="lb-self-name">You</div>
                <div class="text-yellow-400 font-bold" id="lb-self-xp">0 XP</div>
            </div>
        </div>
    </div>

    <!-- Logic -->
    <script>
        const AdaptLearnPro = {
            data: { activities: [], progress: [], user: null, currentWorld: null },
            
            init: {
                run: async () => {
                    AdaptLearnPro.auth.check();
                    // If no user, show login immediately
                    if(!AdaptLearnPro.data.user) {
                        AdaptLearnPro.render.guest();
                        return;
                    }

                    await AdaptLearnPro.api.fetchAll();
                    AdaptLearnPro.render.nav();
                    AdaptLearnPro.render.dashboard();
                    document.getElementById('dashboard-content').classList.remove('hidden');
                    
                    AdaptLearnPro.init.listeners();
                },
                listeners: () => {
                    const inp = document.getElementById('chatInput');
                    if(inp) inp.addEventListener('keypress', (e) => e.key === 'Enter' && AdaptLearnPro.ai.send());
                }
            },

            auth: {
                check: () => {
                    const uid = sessionStorage.getItem('user_id');
                    if(uid) AdaptLearnPro.data.user = { 
                        id: uid, name: sessionStorage.getItem('user_name'), role: sessionStorage.getItem('user_role'),
                        level: 1, xp: 0, coins: 0, streak: 0 // defaults
                    };
                },
                logout: () => { sessionStorage.clear(); window.location.reload(); }
            },

            ui: {
                toggleMobileMenu: () => {
                    const menu = document.getElementById('mobileMenu');
                    if(menu.classList.contains('hidden')) menu.classList.remove('hidden', 'flex');
                    else menu.classList.add('hidden');
                    menu.style.display = menu.classList.contains('hidden') ? 'none' : 'flex';
                },
                toggleAI: () => {
                    const ai = document.getElementById('ai-tutor-content');
                    ai.classList.toggle('hidden');
                },
                backToWorlds: () => {
                    AdaptLearnPro.data.currentWorld = null;
                    AdaptLearnPro.render.dashboard();
                },
                selectWorld: (cat) => {
                    AdaptLearnPro.data.currentWorld = cat;
                    AdaptLearnPro.render.dashboard();
                }
            },

            api: {
                fetchAll: async () => {
                    try {
                        const [uRes, aRes] = await Promise.all([
                            fetch(`/api/analytics?userId=${AdaptLearnPro.data.user.id}`),
                            fetch('/api/activities')
                        ]);
                        const uData = await uRes.json();
                        const aData = await aRes.json();
                        
                        AdaptLearnPro.data.activities = aData;
                        AdaptLearnPro.data.progress = uData;
                        if(uData.user) AdaptLearnPro.data.user = { ...AdaptLearnPro.data.user, ...uData.user };
                    } catch(e) { console.error('API Error', e); }
                }
            },

            render: {
                guest: () => {
                    document.getElementById('hudGuest').classList.remove('hidden');
                    document.getElementById('hudPC').classList.add('hidden');
                    document.getElementById('dashboard-content').innerHTML = `
                        <div class="text-center py-20 text-white">
                            <h1 class="text-4xl font-bold mb-4">Welcome to AdaptLearn Adventure</h1>
                            <p class="text-slate-400 mb-8">Please login to start your journey.</p>
                            <a href="/login.html" class="btn-game px-8 py-3 rounded-xl text-xl font-bold shadow-lg">Start Game</a>
                        </div>
                    `;
                    document.getElementById('dashboard-content').classList.remove('hidden');
                },
                nav: () => {
                    const u = AdaptLearnPro.data.user;
                    if(u) {
                        document.getElementById('hudGuest').classList.add('hidden');
                        document.getElementById('hudPC').classList.remove('hidden');
                        document.getElementById('mobileMenuBtn').classList.remove('hidden');
                        document.getElementById('aiFloatingBtn').classList.remove('hidden');
                        
                        // Populate Data
                        document.getElementById('hudCoins').innerText = u.coins || 0;
                        document.getElementById('hudStreak').innerText = u.streak || 0;
                        document.getElementById('hudName').innerText = u.name;
                        document.getElementById('hudAvatar').innerText = u.avatar || 'ğŸ™‚';
                        
                        // Mobile Menu Data
                        document.getElementById('mobName').innerText = u.name;
                        document.getElementById('mobAvatar').innerText = u.avatar || 'ğŸ™‚';
                        if(u.role === 'admin' || u.role === 'teacher') document.getElementById('mobLinkAdmin').classList.remove('hidden');
                    }
                },
                dashboard: () => {
                    const u = AdaptLearnPro.data.user;
                    if(!u) return;
                    
                    document.getElementById('lobbyAvatar').innerText = u.avatar || 'ğŸ™‚';
                    document.getElementById('lobbyRole').innerText = u.role || 'Novice';
                    
                    const mapTitle = document.querySelector('#dashboard-content h2'); 
                    if (AdaptLearnPro.data.currentWorld) {
                        if(mapTitle) mapTitle.innerHTML = `
                            <button onclick="AdaptLearnPro.ui.backToWorlds()" class="mr-3 text-white hover:text-yellow-400 transition bg-slate-800 rounded-full w-10 h-10 text-xl border border-slate-600">â¬…ï¸</button>
                            <span>ğŸ—ºï¸</span> ${AdaptLearnPro.data.currentWorld}
                        `;
                        AdaptLearnPro.map.render(AdaptLearnPro.data.currentWorld);
                    } else {
                        if(mapTitle) mapTitle.innerHTML = `<span>ğŸŒŒ</span> Galactic Map`;
                        AdaptLearnPro.render.worlds();
                    }
                },
                worlds: () => {
                    const acts = AdaptLearnPro.data.activities;
                    const container = document.getElementById('mapNodes');
                    const svg = document.getElementById('mapLines');
                    if(!container || !svg) return;
                    
                    container.innerHTML = ''; svg.innerHTML = '';
                    document.getElementById('mapContainer').style.background = 'radial-gradient(circle at center, #0f172a 0%, #020617 100%)'; 

                    const categories = [...new Set(acts.map(a => a.category || 'General'))];
                    
                    categories.forEach((cat, i) => {
                        const row = Math.floor(i / 2);
                        const col = i % 2;
                        
                        const planet = document.createElement('div');
                        planet.className = `absolute w-32 h-32 sm:w-48 sm:h-48 rounded-full border-4 border-slate-600 flex flex-col items-center justify-center cursor-pointer transition transform hover:scale-110 hover:border-indigo-400 z-20 shadow-2xl bg-gradient-to-br from-slate-700 to-slate-900 group`;
                        
                        planet.style.top = `${50 + (row * 220)}px`;
                        planet.style.left = col === 0 ? '15%' : '55%'; // Adjusted for mobile/desktop
                        
                        const icons = { 'Mathematics': 'ğŸ“', 'Science': 'ğŸ§ª', 'English': 'ğŸ“š', 'Technology': 'ğŸ’»', 'General': 'ğŸŒ' };
                        planet.innerHTML = `
                            <div class="text-4xl sm:text-6xl mb-2 group-hover:animate-bounce filter drop-shadow-lg">${icons[cat] || 'ğŸª'}</div>
                            <div class="font-bold text-white text-sm sm:text-lg">${cat}</div>
                        `;
                        
                        planet.onclick = () => AdaptLearnPro.ui.selectWorld(cat);
                        container.appendChild(planet);
                    });
                    
                    container.style.height = `${(Math.ceil(categories.length/2) * 220) + 100}px`;
                }
            },
            
            map: {
                render: (category) => {
                    const acts = AdaptLearnPro.data.activities.filter(a => (a.category || 'General') === category);
                    const prog = AdaptLearnPro.data.progress.activities || [];
                    const container = document.getElementById('mapNodes');
                    const svg = document.getElementById('mapLines');
                    if(!container || !svg) return;
                    
                    container.innerHTML = ''; svg.innerHTML = '';

                    acts.forEach((act, i) => {
                        const isDone = prog.find(p => p.activity_id === act.id && p.status === 'completed');
                        const isLocked = i > 0 && !prog.find(p => p.activity_id === acts[i-1].id && p.status === 'completed');
                        
                        const top = 50 + (i * 150);
                        const positions = ['10%', '40%', '70%', '40%']; // Tighter zig-zag for mobile
                        const leftPos = positions[i % 4];
                        
                        const node = document.createElement('div');
                        node.className = `absolute w-16 h-16 sm:w-20 sm:h-20 rounded-2xl border-4 flex flex-col items-center justify-center cursor-pointer transition transform hover:scale-110 z-20 shadow-[0_10px_20px_rgba(0,0,0,0.5)] 
                            ${isLocked ? 'bg-slate-700 border-slate-600 grayscale opacity-70' : (isDone ? 'bg-emerald-600 border-emerald-400' : 'bg-yellow-500 border-yellow-300 animate-pulse')}`;
                        node.style.top = `${top}px`;
                        node.style.left = leftPos;
                        
                        const icon = act.type==='video'?'ğŸ“œ':(act.type==='game'?'ğŸ®':'ğŸ§ª');
                        node.innerHTML = `<span class="text-2xl sm:text-3xl filter drop-shadow-md">${isLocked ? 'ğŸ”’' : icon}</span>`;
                        
                        // Label
                        const label = document.createElement('div');
                        label.className = `absolute -bottom-8 left-1/2 -translate-x-1/2 whitespace-nowrap text-[10px] sm:text-xs font-bold px-2 py-1 rounded bg-slate-900 text-white border border-slate-600 z-30 shadow-xl`;
                        label.innerText = (i+1) + ". " + act.title;
                        node.appendChild(label);

                        node.onclick = () => {
                            if(isLocked) alert('Locked!');
                            else alert('Starting: ' + act.title); // Placeholder for start function
                        };

                        container.appendChild(node);

                        if(i > 0) {
                            const prevPos = positions[(i-1)%4];
                            const conW = container.offsetWidth || 300;
                            const x1 = (parseFloat(prevPos)/100) * conW + 32; // Approx center offset
                            const y1 = (50 + ((i-1) * 150)) + 32;
                            const x2 = (parseFloat(leftPos)/100) * conW + 32;
                            const y2 = top + 32;
                            
                            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                            const cx = (x1 + x2) / 2; const cy = (y1 + y2) / 2;
                            path.setAttribute("d", `M ${x1} ${y1} Q ${cx} ${cy} ${x2} ${y2}`);
                            path.setAttribute("fill", "none");
                            path.setAttribute("stroke", isLocked ? "#475569" : "#fbbf24");
                            path.setAttribute("stroke-width", "4");
                            path.setAttribute("stroke-dasharray", isLocked ? "5,5" : "none");
                            svg.appendChild(path);
                        }
                    });
                    
                    container.style.height = `${(acts.length * 150) + 200}px`;
                }
            },
            
            // ... (keep leader, shop, ai logic - omitted for brevity but assumed present or will add via separate replace if needed.
            // Wait, I am overwriting the WHOLE file. I MUST include Leaderboard, Shop, AI logic here or they will be lost.
            // I will add them back now in this single write_file call to be safe.)
            
            leaderboard: {
                open: async () => {
                    document.getElementById('leaderboardModal').classList.remove('hidden');
                    const list = document.getElementById('lb-list');
                    list.innerHTML = 'Loading...';
                    try {
                        const res = await fetch('/api/leaderboard');
                        const data = await res.json();
                        list.innerHTML = data.map((u,i) => `<div class="flex justify-between p-2 border-b border-slate-700"><span class="text-white">#${i+1} ${u.name}</span><span class="text-yellow-400">${u.xp} XP</span></div>`).join('');
                    } catch(e) { list.innerHTML = 'Error'; }
                }
            },
            shop: {
                open: async () => {
                    document.getElementById('shopModal').classList.remove('hidden');
                    AdaptLearnPro.shop.fetchItems();
                },
                fetchItems: async () => {
                    const list = document.getElementById('shop-list');
                    list.innerHTML = 'Loading...';
                    try {
                        const res = await fetch('/api/shop');
                        const items = await res.json();
                        list.innerHTML = items.map(i => `<div class="bg-slate-800 p-3 rounded mb-2 flex justify-between items-center"><div class="text-white">${i.icon} ${i.name}</div><button onclick="AdaptLearnPro.shop.buy(${i.id})" class="bg-blue-600 px-3 py-1 rounded text-white text-xs">Buy ${i.price}</button></div>`).join('');
                    } catch(e) { list.innerHTML = 'Error'; }
                },
                buy: async (id) => {
                    if(!confirm('Buy?')) return;
                    try {
                        const res = await fetch('/api/shop/buy', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({userId: AdaptLearnPro.data.user.id, itemId: id}) });
                        const d = await res.json();
                        if(d.success) { alert('Bought!'); AdaptLearnPro.data.user.coins = d.new_balance; AdaptLearnPro.render.nav(); }
                        else alert('Failed: ' + d.error);
                    } catch(e) { alert('Error'); }
                },
                fetchInventory: () => {} // Placeholder
            },
            ai: {
                send: async () => {
                    const inp = document.getElementById('chatInput');
                    const msg = inp.value;
                    if(!msg) return;
                    const box = document.getElementById('chatMessages');
                    box.innerHTML += `<div class="text-right text-white mb-2"><span class="bg-indigo-600 px-3 py-1 rounded">${msg}</span></div>`;
                    inp.value = '';
                    // Simple mock response for now to ensure UI works
                    setTimeout(() => {
                        box.innerHTML += `<div class="text-left text-white mb-2"><span class="bg-slate-700 px-3 py-1 rounded">Thinking...</span></div>`;
                    }, 500);
                }
            }
        };
        document.addEventListener('DOMContentLoaded', AdaptLearnPro.init.run);
    </script>
</body>
</html>