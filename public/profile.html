<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - AdaptLearn Adventure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .cover-gradient { background: linear-gradient(to bottom, transparent, #0f172a); }
    </style>
</head>
<body class="min-h-screen bg-slate-900 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">

    <!-- Navbar -->
    <nav class="fixed top-0 w-full z-50 glass px-4 py-3 flex justify-between items-center">
        <a href="/index.html" class="flex items-center gap-2 text-white font-bold hover:text-indigo-400 transition">
            <span>‚¨ÖÔ∏è</span> Back to Adventure
        </a>
        <div class="text-slate-400 text-sm font-bold uppercase tracking-widest">Hero Profile</div>
        <div class="w-8"></div> <!-- Spacer -->
    </nav>

    <main class="pt-20 pb-12 px-4 max-w-5xl mx-auto">
        
        <!-- Header Profile -->
        <div class="relative rounded-3xl overflow-hidden shadow-2xl bg-slate-800 border border-slate-700 group">
            <!-- Cover -->
            <div id="p-cover" class="h-64 w-full bg-gradient-to-r from-indigo-900 to-purple-900 bg-cover bg-center relative">
                <div class="absolute inset-0 bg-black/20"></div>
                <button onclick="document.getElementById('cover-input').click()" class="absolute top-4 right-4 bg-black/50 hover:bg-black/70 text-white px-3 py-1 rounded-lg text-xs backdrop-blur opacity-0 group-hover:opacity-100 transition">üì∑ Change Cover</button>
                <input type="file" id="cover-input" class="hidden" accept="image/*" onchange="App.upload('cover', this)">
            </div>
            
            <!-- Info -->
            <div class="px-8 pb-8 pt-16 relative">
                <!-- Avatar -->
                <div class="absolute -top-16 left-8">
                    <div class="w-32 h-32 rounded-full border-4 border-slate-800 bg-slate-700 flex items-center justify-center text-6xl shadow-xl overflow-hidden cursor-pointer group/avatar relative" onclick="document.getElementById('avatar-input').click()">
                        <span id="p-avatar-emoji">üôÇ</span>
                        <img id="p-avatar-img" class="w-full h-full object-cover hidden">
                        <div class="absolute inset-0 bg-black/50 flex items-center justify-center text-white text-xs opacity-0 group-hover/avatar:opacity-100 transition">üì∑ Edit</div>
                    </div>
                    <input type="file" id="avatar-input" class="hidden" accept="image/*" onchange="App.upload('avatar', this)">
                </div>

                <div class="flex flex-col md:flex-row justify-between items-start md:items-center pl-36 min-h-[60px]">
                    <div>
                        <h1 class="text-3xl font-black text-white" id="p-name">Loading...</h1>
                        <p class="text-indigo-400 font-bold uppercase text-sm tracking-wide" id="p-role">Student</p>
                    </div>
                    <div class="mt-4 md:mt-0 flex gap-3">
                        <button onclick="App.modal.edit()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-xl font-bold text-sm transition border border-slate-600">‚úèÔ∏è Edit Profile</button>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-8">
                    <div class="bg-slate-700/50 p-4 rounded-2xl border border-slate-600 text-center">
                        <div class="text-2xl font-black text-white" id="s-level">1</div>
                        <div class="text-[10px] text-slate-400 uppercase font-bold">Level</div>
                    </div>
                    <div class="bg-slate-700/50 p-4 rounded-2xl border border-slate-600 text-center">
                        <div class="text-2xl font-black text-yellow-400" id="s-xp">0</div>
                        <div class="text-[10px] text-slate-400 uppercase font-bold">Total XP</div>
                    </div>
                    <div class="bg-slate-700/50 p-4 rounded-2xl border border-slate-600 text-center">
                        <div class="text-2xl font-black text-green-400" id="s-rank">-</div>
                        <div class="text-[10px] text-slate-400 uppercase font-bold">Rank</div>
                    </div>
                    <div class="bg-slate-700/50 p-4 rounded-2xl border border-slate-600 text-center">
                        <div class="text-2xl font-black text-blue-400" id="s-certs">0</div>
                        <div class="text-[10px] text-slate-400 uppercase font-bold">Certificates</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
            <!-- Left: Bio & Details -->
            <div class="space-y-6">
                <div class="glass p-6 rounded-2xl">
                    <h3 class="text-lg font-bold text-white mb-4">üìú About Me</h3>
                    <p class="text-slate-400 text-sm leading-relaxed" id="p-bio">No bio yet.</p>
                    
                    <div class="mt-6 space-y-3 pt-6 border-t border-slate-700">
                        <div class="flex items-center gap-3 text-sm text-slate-300">
                            <span class="w-6 text-center">üìß</span> <span id="p-email">-</span>
                        </div>
                        <div class="flex items-center gap-3 text-sm text-slate-300">
                            <span class="w-6 text-center">üè´</span> <span id="p-school">-</span>
                        </div>
                        <div class="flex items-center gap-3 text-sm text-slate-300">
                            <span class="w-6 text-center">üéÇ</span> <span id="p-birthdate">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Content -->
            <div class="lg:col-span-2 space-y-6">
                <!-- XP Progress -->
                <div class="glass p-6 rounded-2xl">
                    <div class="flex justify-between items-end mb-2">
                        <h3 class="font-bold text-white">Level Progress</h3>
                        <span class="text-xs text-indigo-300 font-bold" id="s-xp-label">0 / 100 XP</span>
                    </div>
                    <div class="w-full h-4 bg-slate-800 rounded-full overflow-hidden p-0.5 border border-slate-600">
                        <div id="s-xp-bar" class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 rounded-full shadow-[0_0_10px_rgba(99,102,241,0.5)]" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Certificates -->
                <div class="glass p-6 rounded-2xl">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><span>üèÜ</span> Achievements</h3>
                    <div id="cert-gallery" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="text-slate-500 text-sm italic col-span-2 text-center py-4">No certificates earned yet.</div>
                    </div>
                </div>

                <!-- Login History -->
                <div class="glass p-6 rounded-2xl">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><span>üïí</span> Login History</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-400">
                            <thead class="text-xs text-slate-500 uppercase bg-slate-800">
                                <tr>
                                    <th class="px-4 py-2 rounded-l-lg">Time</th>
                                    <th class="px-4 py-2">Device</th>
                                    <th class="px-4 py-2 rounded-r-lg">IP</th>
                                </tr>
                            </thead>
                            <tbody id="login-history-body">
                                <tr><td colspan="3" class="text-center py-4">Loading history...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 z-50 bg-black/80 flex items-center justify-center hidden backdrop-blur-sm p-4">
        <div class="bg-slate-900 w-full max-w-lg rounded-2xl border border-slate-700 shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                <h3 class="font-bold text-white">Edit Profile</h3>
                <button onclick="App.modal.close()" class="text-slate-400 hover:text-white">‚úï</button>
            </div>
            <div class="p-6 overflow-y-auto space-y-4">
                <div><label class="text-xs text-slate-400 uppercase">Display Name</label><input id="inp-name" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white"></div>
                <div><label class="text-xs text-slate-400 uppercase">Bio</label><textarea id="inp-bio" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white h-24"></textarea></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs text-slate-400 uppercase">Email</label><input id="inp-email" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white"></div>
                    <div><label class="text-xs text-slate-400 uppercase">Phone</label><input id="inp-phone" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white"></div>
                </div>
                <div><label class="text-xs text-slate-400 uppercase">School</label><input id="inp-school" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white"></div>
                <div><label class="text-xs text-slate-400 uppercase">Birthdate</label><input type="date" id="inp-birthdate" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white"></div>
            </div>
            <div class="p-4 border-t border-slate-800 flex justify-end gap-2">
                <button onclick="App.modal.close()" class="px-4 py-2 text-slate-400 hover:text-white">Cancel</button>
                <button onclick="App.save()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-lg">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        const App = {
            user: null,
            init: async () => {
                const uid = sessionStorage.getItem('user_id');
                if(!uid) { location.href = '/login.html'; return; }
                
                try {
                    // Try Analytics first (Rich Data)
                    let res = await fetch(`/api/analytics?userId=${uid}&includeRank=true`);
                    let data = await res.json();
                    
                    // Fallback if Analytics fails or user is null
                    if(!res.ok || !data.user || !data.user.id) {
                        console.warn("Analytics fetch failed, falling back to basic user fetch");
                        res = await fetch('/api/users');
                        const users = await res.json();
                        App.user = users.find(u => String(u.id) === String(uid));
                        // Mock empty analytics structure
                        data = { user: App.user, rank: '-', certificates: [], activities: [] };
                    } else {
                        App.user = data.user;
                    }

                    if(App.user) {
                        App.render(data);
                        App.loadHistory(); // New
                    } else {
                        alert('User not found. Please login again.');
                        location.href = '/login.html';
                    }
                } catch(e) {
                    console.error(e);
                    alert('Connection Error. Showing cached/demo data.');
                }
            },
            loadHistory: async () => {
                const tbody = document.getElementById('login-history-body');
                try {
                    const res = await fetch(`/api/history?userId=${App.user.id}`);
                    const data = await res.json();
                    if(data.length > 0) {
                        tbody.innerHTML = data.map(log => `
                            <tr class="border-b border-slate-700 hover:bg-slate-800/50">
                                <td class="px-4 py-3">${new Date(log.login_time).toLocaleString('th-TH')}</td>
                                <td class="px-4 py-3 truncate max-w-[150px]" title="${log.device_info}">${log.device_info.split('(')[0]}</td>
                                <td class="px-4 py-3 font-mono text-xs">${log.ip_address}</td>
                            </tr>
                        `).join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4">No login history found.</td></tr>';
                    }
                } catch(e) { tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-red-400">Failed to load history.</td></tr>'; }
            },
            render: (data) => {
                const u = App.user;
                const setText = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val || '-'; }
                
                setText('p-name', u.name);
                setText('p-role', u.role);
                setText('p-bio', u.bio || 'No bio provided.');
                setText('p-email', u.email);
                setText('p-school', u.school);
                setText('p-birthdate', u.birthdate);
                
                setText('s-level', u.level || 1);
                setText('s-xp', (u.xp || 0).toLocaleString());
                setText('s-rank', data.rank ? `#${data.rank}` : '-');
                setText('s-certs', (data.certificates || []).length);

                // Avatar
                const avTxt = document.getElementById('p-avatar-emoji');
                const avImg = document.getElementById('p-avatar-img');
                if(u.avatar && u.avatar.includes('/')) {
                    avImg.src = u.avatar; avImg.classList.remove('hidden'); avTxt.classList.add('hidden');
                } else {
                    avTxt.innerText = u.avatar || 'üôÇ'; avTxt.classList.remove('hidden'); avImg.classList.add('hidden');
                }

                // Cover
                if(u.cover_image) document.getElementById('p-cover').style.backgroundImage = `url('${u.cover_image}')`;

                // Bar
                const nextXP = (u.level || 1) * 100;
                const pct = Math.min(((u.xp || 0) / nextXP) * 100, 100);
                document.getElementById('s-xp-bar').style.width = pct + '%';
                document.getElementById('s-xp-label').innerText = `${u.xp||0} / ${nextXP} XP`;

                // Certs
                const certBox = document.getElementById('cert-gallery');
                if(data.certificates && data.certificates.length > 0) {
                    certBox.innerHTML = data.certificates.map(c => `
                        <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 flex items-center gap-3">
                            <div class="text-2xl">üèÜ</div>
                            <div><div class="font-bold text-white text-sm">${c.course_title}</div><div class="text-[10px] text-slate-500">${c.issue_date}</div></div>
                        </div>`).join('');
                }
            },
            modal: {
                edit: () => {
                    const u = App.user;
                    document.getElementById('editModal').classList.remove('hidden');
                    document.getElementById('inp-name').value = u.name || '';
                    document.getElementById('inp-bio').value = u.bio || '';
                    document.getElementById('inp-email').value = u.email || '';
                    document.getElementById('inp-phone').value = u.phone || '';
                    document.getElementById('inp-school').value = u.school || '';
                    document.getElementById('inp-birthdate').value = u.birthdate || '';
                },
                close: () => document.getElementById('editModal').classList.add('hidden')
            },
            save: async () => {
                const body = {
                    id: App.user.id,
                    name: document.getElementById('inp-name').value,
                    bio: document.getElementById('inp-bio').value,
                    email: document.getElementById('inp-email').value,
                    phone: document.getElementById('inp-phone').value,
                    school: document.getElementById('inp-school').value,
                    birthdate: document.getElementById('inp-birthdate').value
                };
                const res = await fetch('/api/users', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
                if(res.ok) { location.reload(); } else { alert('Save failed'); }
            },
            upload: async (type, input) => {
                if(!input.files[0]) return;
                const fd = new FormData(); fd.append('file', input.files[0]);
                const res = await fetch('/api/upload', { method: 'POST', body: fd });
                const d = await res.json();
                if(d.success) {
                    const body = { id: App.user.id };
                    if(type==='avatar') body.avatar = d.url; else body.cover_image = d.url;
                    await fetch('/api/users', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
                    location.reload();
                }
            }
        };
        App.init();
    </script>
</body>
</html>