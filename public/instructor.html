<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instructor Studio - AdaptLearn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #0f172a; color: white; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body class="bg-slate-900">

    <!-- Navbar -->
    <nav class="border-b border-slate-700 bg-slate-800/80 backdrop-blur sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2 font-bold text-xl">
                <span>üßô‚Äç‚ôÇÔ∏è</span> <span>Instructor Studio</span>
            </div>
            <a href="/index.html" class="text-sm text-slate-400 hover:text-white transition">Exit to App ‚ûî</a>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-8">
        
        <!-- Header & Filters -->
        <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-bold mb-1">My Courses</h1>
                <p class="text-slate-400 text-sm">Manage your learning content.</p>
            </div>
            <div class="flex gap-3">
                <select onchange="CourseEditor.filter(this.value)" class="bg-slate-800 border border-slate-700 text-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500">
                    <option value="all">All Subjects</option>
                    <option value="Mathematics">Mathematics</option>
                    <option value="Science">Science</option>
                    <option value="English">English</option>
                    <option value="Technology">Technology</option>
                </select>
                <button onclick="CourseEditor.new()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded-lg font-bold shadow-lg transition flex items-center gap-2">
                    <span>+</span> Create New
                </button>
            </div>
        </div>

        <!-- Course Grid -->
        <div id="course-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="text-slate-500 text-center col-span-full py-12">Loading courses...</div>
        </div>
    </main>

    <!-- EDITOR MODAL (Full Screen) -->
    <div id="editor-modal" class="fixed inset-0 bg-slate-900 z-[60] hidden flex flex-col">
        <!-- Editor Header -->
        <div class="h-16 border-b border-slate-700 flex items-center justify-between px-6 bg-slate-800">
            <h2 class="font-bold text-lg">‚úèÔ∏è Course Editor</h2>
            <div class="flex gap-3">
                <button onclick="CourseEditor.close()" class="text-slate-400 hover:text-white px-3">Cancel</button>
                <button onclick="CourseEditor.save()" class="bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded-lg font-bold">Save Course</button>
            </div>
        </div>

        <!-- Editor Content -->
        <div class="flex-1 overflow-y-auto p-6 flex gap-8">
            <!-- Left: Settings -->
            <div class="w-1/3 space-y-6">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Course Title</label>
                    <input id="c-title" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-white focus:border-indigo-500 outline-none" placeholder="Ex: Introduction to Python">
                </div>
                
                <!-- Category & Type -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Subject</label>
                        <select id="c-category" onchange="CourseEditor.updateIcon()" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-white">
                            <option value="Mathematics">üßÆ Mathematics</option>
                            <option value="Science">üß™ Science</option>
                            <option value="English">üìù English</option>
                            <option value="Technology">üíª Technology</option>
                            <option value="General">üåç General</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Learning Style</label>
                        <select id="c-type" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-white">
                            <option value="video">üé• Video Lecture</option>
                            <option value="game">üéÆ Interactive Game</option>
                            <option value="simulation">üî¨ Simulation</option>
                            <option value="reading">üìñ Reading</option>
                        </select>
                    </div>
                </div>

                <!-- Difficulty & Duration -->
                <div class="grid grid-cols-2 gap-4">
                     <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Difficulty</label>
                        <select id="c-difficulty" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-white">
                            <option value="Easy">üü¢ Easy</option>
                            <option value="Medium">üü° Medium</option>
                            <option value="Hard">üî¥ Hard</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Duration</label>
                        <input id="c-duration" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-white" placeholder="e.g. 30m">
                    </div>
                </div>

                <!-- Credits & Code -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Credits (XP)</label>
                        <input type="number" id="c-credits" value="100" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-white">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Course Code</label>
                        <input id="c-code" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-white" placeholder="e.g. MATH101">
                    </div>
                </div>
            </div>

            <!-- Right: Content Builder -->
            <div class="w-2/3 bg-slate-800/50 rounded-2xl border border-slate-700 p-6 flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-slate-300">Course Content</h3>
                    <div class="flex gap-2">
                        <button onclick="CourseEditor.addModule('video')" class="text-xs bg-slate-700 px-3 py-1.5 rounded hover:bg-slate-600">+ Video</button>
                        <button onclick="CourseEditor.addModule('text')" class="text-xs bg-slate-700 px-3 py-1.5 rounded hover:bg-slate-600">+ Text</button>
                        <button onclick="CourseEditor.addModule('quiz')" class="text-xs bg-slate-700 px-3 py-1.5 rounded hover:bg-slate-600">+ Quiz</button>
                    </div>
                </div>
                
                <div id="module-list" class="flex-1 overflow-y-auto space-y-4 pr-2">
                    <!-- Modules will be added here -->
                    <div class="text-center text-slate-500 py-12 border-2 border-dashed border-slate-700 rounded-xl">
                        Start by adding a module above
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CourseEditor = {
            currentId: null,
            modules: [],
            courses: [], // Store for filtering

            init: async () => {
                const uid = sessionStorage.getItem('user_id');
                if(!uid) { location.href = '/login.html'; return; }
                
                try {
                    const res = await fetch(`/api/activities?instructorId=${uid}`);
                    CourseEditor.courses = await res.json();
                    CourseEditor.renderList();
                } catch(e) { console.error(e); }
            },

            renderList: (filterCat = 'all') => {
                const list = document.getElementById('course-list');
                const filtered = filterCat === 'all' ? CourseEditor.courses : CourseEditor.courses.filter(c => c.category === filterCat);

                if(filtered.length === 0) {
                    list.innerHTML = `<div class="col-span-full text-center py-12 text-slate-500">No courses found.</div>`;
                    return;
                }

                const colors = { 'Mathematics': 'from-orange-500 to-red-600', 'Science': 'from-blue-500 to-indigo-600', 'English': 'from-pink-500 to-rose-600', 'Technology': 'from-emerald-500 to-teal-600', 'General': 'from-slate-600 to-slate-700' };

                list.innerHTML = filtered.map(c => `
                    <div class="bg-slate-800 rounded-2xl overflow-hidden border border-slate-700 hover:border-indigo-500 transition group relative shadow-lg">
                        <div class="h-32 bg-gradient-to-r ${colors[c.category] || colors['General']} p-6 flex flex-col justify-between relative">
                            <div class="flex justify-between items-start">
                                <span class="text-xs font-bold text-white/80 bg-black/20 px-2 py-1 rounded uppercase tracking-wider">${c.category}</span>
                                <span class="text-xs font-bold text-white bg-black/30 px-2 py-1 rounded">${c.difficulty}</span>
                            </div>
                            <h3 class="text-xl font-bold text-white leading-tight truncate" title="${c.title}">${c.title}</h3>
                        </div>
                        <div class="p-4 bg-slate-800">
                            <div class="flex justify-between text-xs text-slate-400 mb-4">
                                <span>${c.course_code || 'NO-CODE'}</span>
                                <span>${c.duration} ‚Ä¢ ${c.credits} XP</span>
                            </div>
                            <div class="flex justify-between items-center pt-4 border-t border-slate-700">
                                <div class="text-xs text-slate-400">
                                    <span class="text-yellow-400 font-bold">‚≠ê ${Number(c.rating||0).toFixed(1)}</span> (${c.review_count||0})
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="CourseEditor.edit(${c.id})" class="px-3 py-1.5 bg-slate-700 hover:bg-white hover:text-slate-900 transition rounded text-xs font-bold">Edit</button>
                                    <button onclick="CourseEditor.delete(${c.id})" class="px-3 py-1.5 bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white transition rounded text-xs font-bold">Del</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            filter: (cat) => CourseEditor.renderList(cat),

            new: () => {
                CourseEditor.currentId = null;
                CourseEditor.modules = [];
                document.getElementById('c-title').value = '';
                document.getElementById('c-duration').value = '';
                document.getElementById('c-credits').value = 100;
                document.getElementById('c-code').value = '';
                CourseEditor.renderModules();
                document.getElementById('editor-modal').classList.remove('hidden');
            },

            edit: async (id) => {
                const c = CourseEditor.courses.find(x => x.id === id);
                if(!c) return;

                CourseEditor.currentId = c.id;
                document.getElementById('c-title').value = c.title;
                document.getElementById('c-category').value = c.category;
                document.getElementById('c-type').value = c.type;
                document.getElementById('c-duration').value = c.duration;
                document.getElementById('c-credits').value = c.credits;
                document.getElementById('c-difficulty').value = c.difficulty;
                document.getElementById('c-code').value = c.course_code || '';

                try {
                    CourseEditor.modules = typeof c.content === 'string' ? JSON.parse(c.content) : c.content;
                } catch(e) { CourseEditor.modules = []; }
                
                CourseEditor.renderModules();
                document.getElementById('editor-modal').classList.remove('hidden');
            },

            save: async () => {
                const body = {
                    title: document.getElementById('c-title').value,
                    category: document.getElementById('c-category').value,
                    type: document.getElementById('c-type').value,
                    duration: document.getElementById('c-duration').value,
                    difficulty: document.getElementById('c-difficulty').value,
                    credits: parseInt(document.getElementById('c-credits').value),
                    course_code: document.getElementById('c-code').value,
                    content: CourseEditor.modules,
                    creator_id: sessionStorage.getItem('user_id'),
                    requester_id: sessionStorage.getItem('user_id'), 
                    requester_role: 'teacher' 
                };

                if(!body.title) return alert('Title is required');

                const method = CourseEditor.currentId ? 'PUT' : 'POST';
                if(CourseEditor.currentId) body.id = CourseEditor.currentId;

                try {
                    const res = await fetch('/api/activities', {
                        method: method,
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(body)
                    });
                    if(res.ok) {
                        alert('Course saved!');
                        location.reload();
                    } else {
                        alert('Failed to save');
                    }
                } catch(e) { alert('Error saving'); }
            },

            delete: async (id) => {
                if(!confirm('Delete this course?')) return;
                await fetch(`/api/activities?id=${id}&requester_id=${sessionStorage.getItem('user_id')}`, { method: 'DELETE' });
                location.reload();
            },

            close: () => document.getElementById('editor-modal').classList.add('hidden'),
            updateIcon: () => {}, // Placeholder if needed

            // --- MODULE BUILDER LOGIC ---
            addModule: (type) => {
                if(type === 'video') CourseEditor.modules.push({ type: 'video', title: 'New Video', url: '' });
                if(type === 'text') CourseEditor.modules.push({ type: 'text', title: 'Lesson Content', body: '' });
                if(type === 'quiz') CourseEditor.modules.push({ type: 'quiz', question: 'Question?', options: ['A','B','C','D'], correct: 0 });
                CourseEditor.renderModules();
            },

            removeModule: (idx) => {
                CourseEditor.modules.splice(idx, 1);
                CourseEditor.renderModules();
            },

            updateModule: (idx, field, val) => {
                CourseEditor.modules[idx][field] = val;
            },
            
            updateOption: (modIdx, optIdx, val) => {
                CourseEditor.modules[modIdx].options[optIdx] = val;
            },

            renderModules: () => {
                const box = document.getElementById('module-list');
                if(CourseEditor.modules.length === 0) {
                    box.innerHTML = '<div class="text-center text-slate-500 py-12 border-2 border-dashed border-slate-700 rounded-xl">Start by adding a module above</div>';
                    return;
                }

                box.innerHTML = CourseEditor.modules.map((m, i) => {
                    let inner = '';
                    if(m.type === 'video') {
                        inner = `<input onchange="CourseEditor.updateModule(${i}, 'url', this.value)" value="${m.url}" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-sm text-white mb-2" placeholder="YouTube URL or Video Link">`;
                    } else if(m.type === 'text') {
                        inner = `<textarea onchange="CourseEditor.updateModule(${i}, 'body', this.value)" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-sm text-white h-20" placeholder="Write content here...">${m.body}</textarea>`;
                    } else if(m.type === 'quiz') {
                        inner = `
                            <input onchange="CourseEditor.updateModule(${i}, 'question', this.value)" value="${m.question}" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-sm text-white mb-2 font-bold" placeholder="Question">
                            <div class="grid grid-cols-2 gap-2">
                                ${m.options.map((opt, oIdx) => `
                                    <div class="flex items-center gap-1">
                                        <input type="radio" name="correct-${i}" ${m.correct===oIdx?'checked':''} onchange="CourseEditor.updateModule(${i}, 'correct', ${oIdx})">
                                        <input onchange="CourseEditor.updateOption(${i}, ${oIdx}, this.value)" value="${opt}" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-slate-300">
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }

                    return `
                        <div class="bg-slate-700/50 p-4 rounded-xl border border-slate-600 relative group">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs font-bold uppercase text-slate-400 bg-slate-800 px-2 py-0.5 rounded">${m.type}</span>
                                <button onclick="CourseEditor.removeModule(${i})" class="text-slate-500 hover:text-red-400">üóëÔ∏è</button>
                            </div>
                            ${m.type !== 'quiz' ? `<input onchange="CourseEditor.updateModule(${i}, 'title', this.value)" value="${m.title}" class="w-full bg-transparent border-none p-0 text-white font-bold mb-2 focus:ring-0" placeholder="Module Title">` : ''}
                            ${inner}
                        </div>
                    `;
                }).join('');
            }
        };

        document.addEventListener('DOMContentLoaded', CourseEditor.init);
    </script>
</body>
</html>