<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instructor Studio - AdaptLearn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #0f172a; color: white; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body class="bg-slate-900">

    <!-- Navbar -->
    <nav class="border-b border-slate-700 bg-slate-800/80 backdrop-blur sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2 font-bold text-xl">
                <span>üßô‚Äç‚ôÇÔ∏è</span> <span>Instructor Studio</span>
            </div>
            <a href="/index.html" class="text-sm text-slate-400 hover:text-white transition">Exit to App ‚ûî</a>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-8">
        
        <!-- Header & Filters -->
        <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-bold mb-1">My Courses</h1>
                <p class="text-slate-400 text-sm">Manage your learning content.</p>
            </div>
            <div class="flex gap-3">
                <select onchange="CourseEditor.filter(this.value)" class="bg-slate-800 border border-slate-700 text-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500">
                    <option value="all">All Subjects</option>
                    <option value="Mathematics">Mathematics</option>
                    <option value="Science">Science</option>
                    <option value="English">English</option>
                    <option value="Technology">Technology</option>
                </select>
                <button onclick="CourseEditor.new()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded-lg font-bold shadow-lg transition flex items-center gap-2">
                    <span>+</span> Create New
                </button>
            </div>
        </div>

        <!-- Course Grid -->
        <div id="course-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="text-slate-500 text-center col-span-full py-12">Loading courses...</div>
        </div>
    </main>

    <!-- EDITOR MODAL (Full Screen) -->
    <div id="editor-modal" class="fixed inset-0 bg-slate-900 z-[60] hidden flex flex-col">
        <!-- Editor Header -->
        <div class="h-16 border-b border-slate-700 flex items-center justify-between px-6 bg-slate-800">
            <h2 class="font-bold text-lg">‚úèÔ∏è Course Editor</h2>
            <div class="flex gap-3">
                <button onclick="CourseEditor.close()" class="text-slate-400 hover:text-white px-3">Cancel</button>
                <button onclick="CourseEditor.save()" class="bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded-lg font-bold">Save Course</button>
            </div>
        </div>

        <!-- Editor Content -->
        <div class="flex-1 overflow-y-auto p-6 flex gap-8">
            <!-- Left: Settings -->
            <div class="w-1/3 space-y-6">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Course Title</label>
                    <input id="c-title" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-white focus:border-indigo-500 outline-none" placeholder="Ex: Introduction to Python">
                </div>
                
                <!-- Category & Type -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Subject</label>
                        <select id="c-category" onchange="CourseEditor.updateIcon()" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-white">
                            <option value="Mathematics">üßÆ Mathematics</option>
                            <option value="Science">üß™ Science</option>
                            <option value="English">üìù English</option>
                            <option value="Technology">üíª Technology</option>
                            <option value="General">üåç General</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Learning Style</label>
                        <select id="c-type" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-white">
                            <option value="video">üé• Video Lecture</option>
                            <option value="game">üéÆ Interactive Game</option>
                            <option value="simulation">üî¨ Simulation</option>
                            <option value="reading">üìñ Reading</option>
                        </select>
                    </div>
                </div>

                <!-- Difficulty & Duration -->
                <div class="grid grid-cols-2 gap-4">
                     <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Difficulty</label>
                        <select id="c-difficulty" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-white">
                            <option value="Easy">üü¢ Easy</option>
                            <option value="Medium">üü° Medium</option>
                            <option value="Hard">üî¥ Hard</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Duration</label>
                        <input id="c-duration" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-white" placeholder="e.g. 30m">
                    </div>
                </div>

                <!-- Credits & Code -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Credits (XP)</label>
                        <input type="number" id="c-credits" value="100" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-white">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Course Code</label>
                        <input id="c-code" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-white" placeholder="e.g. MATH101">
                    </div>
                </div>
            </div>

            <!-- Right: Content Builder (Multi-Unit) -->
            <div class="w-2/3 bg-slate-800/50 rounded-2xl border border-slate-700 p-6 flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-slate-300">Course Curriculum</h3>
                    <button onclick="CourseEditor.addUnit()" class="text-xs bg-indigo-600 px-4 py-2 rounded-lg font-bold text-white shadow hover:bg-indigo-500">+ Add Unit</button>
                </div>
                
                <div id="unit-list" class="flex-1 overflow-y-auto space-y-6 pr-2">
                    <!-- Units will be added here -->
                    <div class="text-center text-slate-500 py-12 border-2 border-dashed border-slate-700 rounded-xl">
                        Start by adding a Learning Unit above
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CourseEditor = {
            currentId: null,
            curriculum: [], // Array of Units
            courses: [],

            // ... (Init/RenderList/Filter same as before) ...
            init: async () => {
                const uid = sessionStorage.getItem('user_id');
                if(!uid) { location.href = '/login.html'; return; }
                
                try {
                    // Check Role first
                    const uRes = await fetch(`/api/analytics?userId=${uid}`);
                    const uData = await uRes.json();
                    const role = uData.user?.role || 'teacher';

                    // If Admin, fetch ALL courses. If Teacher, fetch only theirs.
                    let url = `/api/activities?instructorId=${uid}`;
                    if (role === 'admin') url = `/api/activities`; // No filter = All

                    const res = await fetch(url);
                    const data = await res.json();
                    
                    console.log(`Fetched Courses (${role}):`, data); 
                    CourseEditor.courses = data;
                    CourseEditor.renderList();
                } catch(e) { 
                    console.error("Load Error:", e);
                    document.getElementById('course-list').innerHTML = `<div class="col-span-full text-red-400 text-center">Failed to load courses.</div>`;
                }
            },

            renderList: (filterCat = 'all') => {
                const list = document.getElementById('course-list');
                const filtered = filterCat === 'all' ? CourseEditor.courses : CourseEditor.courses.filter(c => c.category === filterCat);

                if(filtered.length === 0) {
                    list.innerHTML = `
                        <div class="col-span-full text-center py-12 flex flex-col items-center">
                            <div class="text-4xl mb-4">üì≠</div>
                            <h3 class="text-xl font-bold text-slate-400">No courses found</h3>
                            <p class="text-slate-500 text-sm mt-2">You haven't created any courses yet (or filter hidden them).</p>
                            <button onclick="CourseEditor.new()" class="mt-4 text-indigo-400 hover:text-indigo-300 underline">Create your first course</button>
                        </div>`;
                    return;
                }
                 const colors = { 'Mathematics': 'from-orange-500 to-red-600', 'Science': 'from-blue-500 to-indigo-600', 'English': 'from-pink-500 to-rose-600', 'Technology': 'from-emerald-500 to-teal-600', 'General': 'from-slate-600 to-slate-700' };
                 list.innerHTML = filtered.map(c => `
                    <div class="bg-slate-800 rounded-2xl overflow-hidden border border-slate-700 hover:border-indigo-500 transition group relative shadow-lg">
                        <div class="h-32 bg-gradient-to-r ${colors[c.category] || colors['General']} p-6 flex flex-col justify-between relative">
                            <div class="flex justify-between items-start">
                                <span class="text-xs font-bold text-white/80 bg-black/20 px-2 py-1 rounded uppercase tracking-wider">${c.category}</span>
                                <span class="text-xs font-bold text-white bg-black/30 px-2 py-1 rounded">${c.difficulty}</span>
                            </div>
                            <h3 class="text-xl font-bold text-white leading-tight truncate" title="${c.title}">${c.title}</h3>
                        </div>
                        <div class="p-4 bg-slate-800">
                            <div class="flex justify-between text-xs text-slate-400 mb-4"><span>${c.course_code || 'NO-CODE'}</span><span>${c.duration} ‚Ä¢ ${c.credits} XP</span></div>
                            <div class="flex justify-between items-center pt-4 border-t border-slate-700">
                                <div class="text-xs text-slate-400"><span class="text-yellow-400 font-bold">‚≠ê ${Number(c.rating||0).toFixed(1)}</span> (${c.review_count||0})</div>
                                <div class="flex gap-2"><button onclick="CourseEditor.edit(${c.id})" class="px-3 py-1.5 bg-slate-700 hover:bg-white hover:text-slate-900 transition rounded text-xs font-bold">Edit</button><button onclick="CourseEditor.delete(${c.id})" class="px-3 py-1.5 bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white transition rounded text-xs font-bold">Del</button></div>
                            </div>
                        </div>
                    </div>`).join('');
            },
            filter: (cat) => CourseEditor.renderList(cat),
            updateIcon: () => {},

            new: () => {
                CourseEditor.currentId = null;
                CourseEditor.curriculum = [];
                document.getElementById('c-title').value = '';
                document.getElementById('c-duration').value = '';
                document.getElementById('c-credits').value = 100;
                document.getElementById('c-code').value = '';
                CourseEditor.renderCurriculum();
                document.getElementById('editor-modal').classList.remove('hidden');
            },

            edit: async (id) => {
                const c = CourseEditor.courses.find(x => x.id === id);
                if(!c) return;
                CourseEditor.currentId = c.id;
                document.getElementById('c-title').value = c.title;
                document.getElementById('c-category').value = c.category;
                document.getElementById('c-type').value = c.type;
                document.getElementById('c-duration').value = c.duration;
                document.getElementById('c-credits').value = c.credits;
                document.getElementById('c-difficulty').value = c.difficulty;
                document.getElementById('c-code').value = c.course_code || '';

                try {
                    // Backwards compatibility: If flat array, wrap in Unit 1
                    const raw = typeof c.content === 'string' ? JSON.parse(c.content) : c.content;
                    if (Array.isArray(raw) && raw.length > 0 && !raw[0].lessons) {
                        CourseEditor.curriculum = [{ title: "Unit 1: Introduction", lessons: raw }];
                    } else {
                        CourseEditor.curriculum = raw || [];
                    }
                } catch(e) { CourseEditor.curriculum = []; }
                
                CourseEditor.renderCurriculum();
                document.getElementById('editor-modal').classList.remove('hidden');
            },

            save: async () => {
                // 1. Fetch User Role first to ensure accuracy
                let role = 'teacher';
                try {
                    const uid = sessionStorage.getItem('user_id');
                    const uRes = await fetch(`/api/analytics?userId=${uid}`);
                    const uData = await uRes.json();
                    if(uData.user && uData.user.role) role = uData.user.role;
                } catch(e) {}

                const body = {
                    title: document.getElementById('c-title').value,
                    category: document.getElementById('c-category').value,
                    type: document.getElementById('c-type').value,
                    duration: document.getElementById('c-duration').value,
                    difficulty: document.getElementById('c-difficulty').value,
                    credits: parseInt(document.getElementById('c-credits').value) || 0,
                    course_code: document.getElementById('c-code').value,
                    content: CourseEditor.modules, // Flat for now, logic handles structure
                    creator_id: sessionStorage.getItem('user_id'),
                    requester_id: sessionStorage.getItem('user_id'), 
                    requester_role: role 
                };

                // Handle nested curriculum if present
                if (CourseEditor.curriculum && CourseEditor.curriculum.length > 0) {
                    body.content = CourseEditor.curriculum;
                }

                if(!body.title) return alert('Title is required');

                const method = CourseEditor.currentId ? 'PUT' : 'POST';
                if(CourseEditor.currentId) body.id = CourseEditor.currentId;

                console.log("Saving Course Payload:", body); // Debug

                try {
                    const res = await fetch('/api/activities', {
                        method: method,
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(body)
                    });
                    const result = await res.json();
                    
                    if(res.ok && result.success) {
                        alert('Course saved successfully!');
                        location.reload();
                    } else {
                        alert(`Failed to save: ${result.error || 'Unknown Error'}`);
                        console.error('Save Error:', result);
                    }
                } catch(e) { 
                    alert('Network Error saving course'); 
                    console.error(e);
                }
            },

            delete: async (id) => { if(!confirm('Delete?')) return; await fetch(`/api/activities?id=${id}&requester_id=${sessionStorage.getItem('user_id')}`, { method: 'DELETE' }); location.reload(); },
            close: () => document.getElementById('editor-modal').classList.add('hidden'),

            // --- HIERARCHICAL BUILDER ---
            addUnit: () => {
                CourseEditor.curriculum.push({ title: `Unit ${CourseEditor.curriculum.length + 1}`, lessons: [] });
                CourseEditor.renderCurriculum();
            },
            
            updateUnitTitle: (uIdx, val) => { CourseEditor.curriculum[uIdx].title = val; },
            removeUnit: (uIdx) => { CourseEditor.curriculum.splice(uIdx, 1); CourseEditor.renderCurriculum(); },

            addLesson: (uIdx, type) => {
                const lesson = { type, title: 'New Lesson', completed: false };
                if (type === 'video') lesson.url = '';
                if (type === 'text') lesson.body = '';
                if (type === 'quiz') { lesson.question = 'Question?'; lesson.options = ['A','B','C','D']; lesson.correct = 0; }
                CourseEditor.curriculum[uIdx].lessons.push(lesson);
                CourseEditor.renderCurriculum();
            },

            updateLesson: (uIdx, lIdx, field, val) => { CourseEditor.curriculum[uIdx].lessons[lIdx][field] = val; },
            updateOption: (uIdx, lIdx, oIdx, val) => { CourseEditor.curriculum[uIdx].lessons[lIdx].options[oIdx] = val; },
            removeLesson: (uIdx, lIdx) => { CourseEditor.curriculum[uIdx].lessons.splice(lIdx, 1); CourseEditor.renderCurriculum(); },

            renderCurriculum: () => {
                const box = document.getElementById('unit-list');
                if(CourseEditor.curriculum.length === 0) { box.innerHTML = '<div class="text-center text-slate-500 py-12 border-2 border-dashed border-slate-700 rounded-xl">Start by adding a Unit</div>'; return; }

                box.innerHTML = CourseEditor.curriculum.map((unit, uIdx) => `
                    <div class="bg-slate-900 border border-slate-700 rounded-xl p-4">
                        <!-- Unit Header -->
                        <div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-800">
                            <input onchange="CourseEditor.updateUnitTitle(${uIdx}, this.value)" value="${unit.title}" class="bg-transparent font-bold text-lg text-white w-full focus:outline-none focus:border-b border-indigo-500" placeholder="Unit Title">
                            <button onclick="CourseEditor.removeUnit(${uIdx})" class="text-slate-500 hover:text-red-400 px-2">üóëÔ∏è</button>
                        </div>
                        
                        <!-- Lessons Container -->
                        <div class="space-y-3 pl-4 border-l-2 border-slate-800">
                            ${unit.lessons.map((l, lIdx) => {
                                let inner = '';
                                if(l.type === 'video') inner = `<input onchange="CourseEditor.updateLesson(${uIdx},${lIdx},'url',this.value)" value="${l.url}" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-xs text-white mb-1" placeholder="Video URL">`;
                                else if(l.type === 'text') inner = `<textarea onchange="CourseEditor.updateLesson(${uIdx},${lIdx},'body',this.value)" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-xs text-white h-16" placeholder="Content...">${l.body}</textarea>`;
                                else if(l.type === 'quiz') inner = `
                                    <input onchange="CourseEditor.updateLesson(${uIdx},${lIdx},'question',this.value)" value="${l.question}" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-xs text-white mb-1 font-bold" placeholder="Question">
                                    <div class="grid grid-cols-2 gap-1">
                                        ${l.options.map((opt, oIdx) => `<div class="flex items-center gap-1"><input type="radio" name="c-${uIdx}-${lIdx}" ${l.correct===oIdx?'checked':''} onchange="CourseEditor.updateLesson(${uIdx},${lIdx},'correct',${oIdx})"><input onchange="CourseEditor.updateOption(${uIdx},${lIdx},${oIdx},this.value)" value="${opt}" class="w-full bg-slate-800 border border-slate-700 rounded px-1 py-0.5 text-[10px] text-slate-300"></div>`).join('')}
                                    </div>`;

                                return `
                                    <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700 group relative">
                                        <div class="flex justify-between items-center mb-1">
                                            <div class="flex items-center gap-2">
                                                <span class="text-[10px] font-bold uppercase text-slate-400 bg-slate-900 px-1.5 rounded">${l.type}</span>
                                                <input onchange="CourseEditor.updateLesson(${uIdx},${lIdx},'title',this.value)" value="${l.title}" class="bg-transparent font-bold text-sm text-white focus:outline-none w-48" placeholder="Lesson Title">
                                            </div>
                                            <button onclick="CourseEditor.removeLesson(${uIdx},${lIdx})" class="text-slate-600 hover:text-red-400">‚úï</button>
                                        </div>
                                        ${inner}
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        <!-- Add Lesson Buttons -->
                        <div class="flex gap-2 flex-wrap">
                        <button onclick="CourseEditor.addLesson(${uIdx}, 'video')" class="text-[10px] bg-slate-800 hover:bg-slate-700 px-3 py-1 rounded text-slate-300">+ Video</button>
                        <button onclick="CourseEditor.addLesson(${uIdx}, 'article')" class="text-[10px] bg-slate-800 hover:bg-slate-700 px-3 py-1 rounded text-slate-300">+ Article</button>
                        <button onclick="CourseEditor.addLesson(${uIdx}, 'quiz')" class="text-[10px] bg-slate-800 hover:bg-slate-700 px-3 py-1 rounded text-slate-300">+ Quiz</button>
                        <button onclick="CourseEditor.addLesson(${uIdx}, 'simulation')" class="text-[10px] bg-slate-800 hover:bg-slate-700 px-3 py-1 rounded text-slate-300">+ Simulation</button>
                        <button onclick="CourseEditor.addLesson(${uIdx}, 'file')" class="text-[10px] bg-slate-800 hover:bg-slate-700 px-3 py-1 rounded text-slate-300">+ File</button>
                    </div>
                `).join('');
            },

            // --- UPLOAD HELPER ---
            uploadMedia: async (fileInput, callback) => {
                const file = fileInput.files[0];
                if(!file) return;
                
                const btn = fileInput.previousElementSibling; // The button that was clicked
                const originalText = btn.innerText;
                btn.innerText = "‚è≥ Uploading...";
                btn.disabled = true;

                try {
                    // Use Vercel Blob API via our proxy
                    const res = await fetch(`/api/upload?filename=${encodeURIComponent(file.name)}`, {
                        method: 'POST',
                        body: file
                    });
                    const data = await res.json();
                    
                    if(data.success) {
                        callback(data.url, file.type);
                    } else {
                        alert('Upload Failed');
                    }
                } catch(e) { console.error(e); alert('Upload Error'); }
                
                btn.innerText = originalText;
                btn.disabled = false;
                fileInput.value = ''; // Reset
            },

            insertTag: (uIdx, lIdx, url, type) => {
                const textarea = document.getElementById(`editor-${uIdx}-${lIdx}`);
                let tag = '';
                if(type.startsWith('image')) tag = `<img src="${url}" class="rounded-xl shadow-lg my-4 max-w-full" />\n`;
                else if(type.startsWith('audio')) tag = `<div class="my-4"><audio controls src="${url}" class="w-full"></audio></div>\n`;
                else tag = `<a href="${url}" target="_blank" class="text-indigo-400 underline">Download File</a>\n`;
                
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = textarea.value;
                const newText = text.substring(0, start) + tag + text.substring(end);
                
                textarea.value = newText;
                CourseEditor.updateLesson(uIdx, lIdx, 'body', newText);
            },

            addLesson: (uIdx, type) => {
                const lesson = { type, title: 'New Lesson', completed: false };
                if (type === 'video') lesson.url = '';
                if (type === 'article') lesson.body = ''; // Rich Text
                if (type === 'quiz') { lesson.question = 'Question?'; lesson.options = ['A','B','C','D']; lesson.correct = 0; }
                if (type === 'simulation') lesson.url = '';
                if (type === 'file') { lesson.url = ''; lesson.filename = 'Resource.pdf'; }
                CourseEditor.curriculum[uIdx].lessons.push(lesson);
                CourseEditor.renderCurriculum();
            },

            // Updated Render Logic inside renderCurriculum...
            renderLessonContent: (l, uIdx, lIdx) => {
                if(l.type === 'video') {
                    // Preview Logic
                    let previewHtml = '';
                    if (l.url) {
                        if (l.url.includes('youtube') || l.url.includes('youtu.be')) {
                            let vidId = '';
                            try { const u = new URL(l.url); vidId = u.searchParams.get('v') || u.pathname.slice(1); } catch(e){}
                            if(vidId) previewHtml = `<iframe src="https://www.youtube.com/embed/${vidId}" class="w-full h-40 rounded-lg mt-2" frameborder="0"></iframe>`;
                        } else {
                            previewHtml = `<video src="${l.url}" controls class="w-full h-40 rounded-lg mt-2 bg-black"></video>`;
                        }
                    }

                    return `
                    <div class="space-y-2">
                        <div class="flex gap-2 items-center">
                            <input id="vid-input-${uIdx}-${lIdx}" onchange="CourseEditor.updateLesson(${uIdx},${lIdx},'url',this.value)" value="${l.url}" class="flex-1 bg-slate-800 border border-slate-700 rounded px-3 py-2 text-xs text-white" placeholder="Paste YouTube URL here">
                            <button onclick="CourseEditor.updateLesson(${uIdx},${lIdx},'url', document.getElementById('vid-input-${uIdx}-${lIdx}').value); CourseEditor.renderCurriculum();" class="bg-indigo-600 hover:bg-indigo-500 px-3 py-2 rounded text-xs text-white font-bold">Embed</button>
                            <button onclick="document.getElementById('vid-up-${uIdx}-${lIdx}').click()" class="bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded text-xs text-white">‚¨Ü Upload</button>
                            <input type="file" id="vid-up-${uIdx}-${lIdx}" class="hidden" accept="video/*" onchange="CourseEditor.uploadMedia(this, (url)=> { document.getElementById('vid-input-${uIdx}-${lIdx}').value = url; CourseEditor.updateLesson(${uIdx},${lIdx},'url',url); CourseEditor.renderCurriculum(); })">
                        </div>
                        ${previewHtml ? `<div class="bg-black/20 p-2 rounded">${previewHtml}</div>` : ''}
                    </div>`;
                }
                
                if(l.type === 'article') return `
                    <div class="flex gap-2 mb-2">
                        <button onclick="document.getElementById('img-up-${uIdx}-${lIdx}').click()" class="bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded text-[10px] flex items-center gap-1">üì∑ Image</button>
                        <input type="file" id="img-up-${uIdx}-${lIdx}" class="hidden" accept="image/*" onchange="CourseEditor.uploadMedia(this, (url, type)=> CourseEditor.insertTag(${uIdx},${lIdx},url,type))">
                        
                        <button onclick="document.getElementById('aud-up-${uIdx}-${lIdx}').click()" class="bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded text-[10px] flex items-center gap-1">üéµ Audio</button>
                        <input type="file" id="aud-up-${uIdx}-${lIdx}" class="hidden" accept="audio/*" onchange="CourseEditor.uploadMedia(this, (url, type)=> CourseEditor.insertTag(${uIdx},${lIdx},url,type))">
                    </div>
                    <textarea id="editor-${uIdx}-${lIdx}" onchange="CourseEditor.updateLesson(${uIdx},${lIdx},'body',this.value)" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-xs text-white h-32" placeholder="Write article content here... (HTML supported)">${l.body}</textarea>`;
                
                if(l.type === 'quiz') return `
                    <input onchange="CourseEditor.updateLesson(${uIdx},${lIdx},'question',this.value)" value="${l.question}" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-xs text-white mb-1 font-bold" placeholder="Question">
                    <div class="grid grid-cols-2 gap-1">
                        ${l.options.map((opt, oIdx) => `<div class="flex items-center gap-1"><input type="radio" name="c-${uIdx}-${lIdx}" ${l.correct===oIdx?'checked':''} onchange="CourseEditor.updateLesson(${uIdx},${lIdx},'correct',${oIdx})"><input onchange="CourseEditor.updateOption(${uIdx},${lIdx},${oIdx},this.value)" value="${opt}" class="w-full bg-slate-800 border border-slate-700 rounded px-1 py-0.5 text-[10px] text-slate-300"></div>`).join('')}
                    </div>`;

                if(l.type === 'simulation') return `<input onchange="CourseEditor.updateLesson(${uIdx},${lIdx},'url',this.value)" value="${l.url}" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-xs text-white mb-1" placeholder="Simulation Embed URL (e.g. PhET, Sketchfab)">`;

                if(l.type === 'file') return `
                    <div class="flex gap-2 items-center">
                        <input onchange="CourseEditor.updateLesson(${uIdx},${lIdx},'filename',this.value)" value="${l.filename}" class="w-1/3 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-xs text-white" placeholder="Display Name">
                        <input onchange="CourseEditor.updateLesson(${uIdx},${lIdx},'url',this.value)" value="${l.url}" class="flex-1 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-xs text-white" placeholder="File URL">
                        <button onclick="document.getElementById('file-up-${uIdx}-${lIdx}').click()" class="bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded text-[10px]">‚¨Ü Upload</button>
                        <input type="file" id="file-up-${uIdx}-${lIdx}" class="hidden" onchange="CourseEditor.uploadMedia(this, (url)=> { document.querySelector('input[placeholder=\\'File URL\\'][value=\\'${l.url}\\']').value = url; CourseEditor.updateLesson(${uIdx},${lIdx},'url',url); })">
                    </div>`;
                
                return '';
            },

            // ... (keep removeLesson, addUnit, updateUnitTitle etc)

            renderCurriculum: () => {
                const box = document.getElementById('unit-list');
                if(CourseEditor.curriculum.length === 0) { box.innerHTML = '<div class="text-center text-slate-500 py-12 border-2 border-dashed border-slate-700 rounded-xl">Start by adding a Unit</div>'; return; }

                box.innerHTML = CourseEditor.curriculum.map((unit, uIdx) => `
                    <div class="bg-slate-900 border border-slate-700 rounded-xl p-4">
                        <div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-800">
                            <input onchange="CourseEditor.updateUnitTitle(${uIdx}, this.value)" value="${unit.title}" class="bg-transparent font-bold text-lg text-white w-full focus:outline-none focus:border-b border-indigo-500" placeholder="Unit Title">
                            <button onclick="CourseEditor.removeUnit(${uIdx})" class="text-slate-500 hover:text-red-400 px-2">üóëÔ∏è</button>
                        </div>
                        <div class="space-y-3 pl-4 border-l-2 border-slate-800">
                            ${unit.lessons.map((l, lIdx) => `
                                <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700 group relative">
                                    <div class="flex justify-between items-center mb-2">
                                        <div class="flex items-center gap-2">
                                            <span class="text-[10px] font-bold uppercase text-slate-400 bg-slate-900 px-1.5 rounded">${l.type}</span>
                                            <input onchange="CourseEditor.updateLesson(${uIdx},${lIdx},'title',this.value)" value="${l.title}" class="bg-transparent font-bold text-sm text-white focus:outline-none w-48" placeholder="Lesson Title">
                                        </div>
                                        <button onclick="CourseEditor.removeLesson(${uIdx},${lIdx})" class="text-slate-600 hover:text-red-400">‚úï</button>
                                    </div>
                                    ${CourseEditor.renderLessonContent(l, uIdx, lIdx)}
                                </div>
                            `).join('')}
                        </div>
                        <div class="flex gap-2 mt-4 ml-4 flex-wrap">
                            <button onclick="CourseEditor.addLesson(${uIdx}, 'video')" class="text-[10px] bg-slate-800 hover:bg-slate-700 px-3 py-1 rounded text-slate-300">+ Video</button>
                            <button onclick="CourseEditor.addLesson(${uIdx}, 'article')" class="text-[10px] bg-slate-800 hover:bg-slate-700 px-3 py-1 rounded text-slate-300">+ Article</button>
                            <button onclick="CourseEditor.addLesson(${uIdx}, 'quiz')" class="text-[10px] bg-slate-800 hover:bg-slate-700 px-3 py-1 rounded text-slate-300">+ Quiz</button>
                            <button onclick="CourseEditor.addLesson(${uIdx}, 'simulation')" class="text-[10px] bg-slate-800 hover:bg-slate-700 px-3 py-1 rounded text-slate-300">+ Simulation</button>
                            <button onclick="CourseEditor.addLesson(${uIdx}, 'file')" class="text-[10px] bg-slate-800 hover:bg-slate-700 px-3 py-1 rounded text-slate-300">+ File</button>
                        </div>
                    </div>
                `).join('');
            }
        };

        document.addEventListener('DOMContentLoaded', CourseEditor.init);
    </script>
</body>
</html>